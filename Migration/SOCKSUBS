002100*  SOCKSUBS   A collection of socket subroutines.                         
002200*------------------------------------------------------------             
002400*     J3KOPENSOCK  - Open a network socket.                               
002600*     J3KREADSOCK  - Read from socket.                                    
002800*     J3KWRITSOCK  - Wite to socket                                       
003000*     J3KCLOSESOCK - Close socket.                                        
003200*     J3KWRITACK   - Write "ACK" to socket.                               
003400*     J3KREADACK   - Read "ACK" from socket.                              
003600*     J3KSOCKERR   - Returns errors messages.                             
003800*     J3KREADSOCKTO- Read from socket, with timeout.                      
004100*     J3KSHOW     - Display's databuffer 40 bytes per line.               
004300*     J3KCONN       - Open a NETWORK communication link.                  
004500*************************************************************             
004600$PAGE "J3KOPENSOCK - OPEN A SOCKET"                                       
005700$CONTROL SYNC32,RLFILE,LIST,DYNAMIC,OPTFEATURES=LINKALIGNED16             
005800 IDENTIFICATION DIVISION.                                                 
005900 PROGRAM-ID. J3KOPENSOCK.                                                 
006000 AUTHOR.     Michael Anderson.                                            
006100 DATE-COMPILED.                                                           
006700* OPEN A SOCKET                                                           
007100 ENVIRONMENT DIVISION.                                                    
007200                                                                          
007300 CONFIGURATION SECTION.                                                   
007400 SOURCE-COMPUTER. HP3000.                                                 
007500* SOURCE-COMPUTER. HP3000 WITH DEBUGGING MODE.                            
007600 OBJECT-COMPUTER. HP3000.                                                 
007700 SPECIAL-NAMES.                                                           
007800     CONDITION-CODE IS CC.                                                
007900                                                                          
008000******************************************************************        
008100 DATA DIVISION.                                                           
008500 WORKING-STORAGE SECTION.                                                 
008600*============================================*                            
008800 01  I                     PIC S9(4) COMP.                                
008900 01  N                     PIC S9(4) COMP.                                
009100 01  THIS-PROG             PIC X(12) VALUE "J3KOPENSOCK ".                
009300 01  PARM                  PIC S9(4) COMP.                                
009500 01  INFO-LEN              PIC S9(4) COMP.                                
009700 COPY INFOSTR OF J3KLIB.                                                  
009900*============================================*                            
010000 LINKAGE SECTION.                                                         
010100*============================================*                            
010300 01  SOCKET-ID            PIC S9(9) COMP SYNC.                            
010500 01  SERVICE-NAME          PIC X(8).                                      
010700 01  PASSWORD              PIC X(8).                                      
010900 01  HOST-NAME             PIC X(8).                                      
011100 01  N-ERR                 PIC S9(4) COMP.                                
011400 PROCEDURE DIVISION USING                                                 
011500     SOCKET-ID SERVICE-NAME PASSWORD HOST-NAME N-ERR.                     
011800 1000-BEGIN.                                                              
011900D    DISPLAY THIS-PROG "1000-BEGIN".                                      
012000     MOVE ZERO TO N-ERR.                                                  
012100     CALL INTRINSIC ".LEN." USING INFO-STRING GIVING INFO-LEN.            
012200     MOVE INFO-LEN TO I.                                                  
012300     CALL INTRINSIC "GETINFO" USING INFO-STRING I PARM.                   
012400     IF I = INFO-LEN AND INFO-MODE = "SERVER"                             
012500D        DISPLAY THIS-PROG "Server mode"                                  
012600         CALL "J3KOPENSRVR" USING SOCKET-ID SERVICE-NAME                  
012700             PASSWORD HOST-NAME N-ERR INFO-STRING PARM                    
012800     ELSE                                                                 
012900D        DISPLAY THIS-PROG "Client mode"                                  
013000         CALL "J3KCLIENT" USING                                           
013100             SOCKET-ID SERVICE-NAME PASSWORD HOST-NAME N-ERR              
013200     END-IF.                                                              
013300                                                                          
013400 1900-RETURN.                                                             
013500D    DISPLAY THIS-PROG "1900-RETURN".                                     
013600     GOBACK.                                                              
013700                                                                          
013800 END PROGRAM J3KOPENSOCK.                                                 
013900$PAGE "J3KOPENSRVR - Establish a server connection"                       
015000$CONTROL SYNC32,RLFILE,LIST,DYNAMIC,OPTFEATURES=LINKALIGNED16             
015100 IDENTIFICATION DIVISION.                                                 
015200 PROGRAM-ID. J3KOPENSRVR.                                                 
015300 AUTHOR.     Michael Anderson.                                            
015400 DATE-COMPILED.                                                           
016400 ENVIRONMENT DIVISION.                                                    
016600 CONFIGURATION SECTION.                                                   
016700 SOURCE-COMPUTER. HP3000.                                                 
016800* SOURCE-COMPUTER. HP3000 WITH DEBUGGING MODE.                            
016900 OBJECT-COMPUTER. HP3000.                                                 
017000 SPECIAL-NAMES.                                                           
017100     CONDITION-CODE IS CC.                                                
017400 DATA DIVISION.                                                           
017800 WORKING-STORAGE SECTION.                                                 
018100 01  I                     PIC S9(4) COMP.                                
018200 01  I2                    PIC S9(9) COMP.                                
018300 01  L                     PIC S9(4) COMP.                                
018400 01  ACKTIMEOUT            PIC S9(4) COMP.                                
018500 01  ACKBUF                PIC X VALUE SPACES.                            
018600     88 GOOD-ACK           VALUE "Y".                                     
018700     88 BAD-ACK            VALUE "N".                                     
018800 01  N                     PIC S9(4) COMP.                                
018900 01  N2                    PIC S9(9) COMP.                                
019000                                                                          
019100 01  THIS-PROG             PIC X(12) VALUE "J3KOPENSRVR ".                
019200                                                                          
019300 01  ERROR-CALL            PIC X(10).                                     
019400 01  ERROR-SOCKET-ID      PIC S9(9) COMP.                                 
019500 01  ERROR-MSG             PIC X(80).                                     
019600                                                                          
019700 01  LONG-ERROR            PIC S9(9) COMP VALUE ZERO.                     
019800 01  FILLER REDEFINES LONG-ERROR.                                         
019900     02  FILLER            PIC XX.                                        
020000     02  SHORT-ERROR       PIC S9(4) COMP.                                
020100                                                                          
020200 01  WORK-NX.                                                             
020300     02  WORK-N            PIC S9(4) COMP.                                
020400                                                                          
020500 01  WORK-X                PIC X(80).                                     
020600                                                                          
020700 01  DISP-N2               PIC 99.                                        
020800 01  DISP-N3               PIC 999.                                       
020900 01  DISP-N4               PIC 9(4).                                      
021000 01  DISP-N8               PIC 9(8).                                      
021100 01  DISP-SN4              PIC ----9.                                     
021200 01  DISP-SN5              PIC -----9.                                    
021300                                                                          
021400*============================================*                            
021500 LINKAGE SECTION.                                                         
021600*============================================*                            
021700                                                                          
021800 01  SOCKET-ID            PIC S9(9) COMP SYNC.                            
022000 01  SERVICE-NAME          PIC X(8).                                      
022200 01  PASSWORD              PIC X(8).                                      
022400 01  HOST-NAME             PIC X(8).                                      
022600 01  N-ERR                 PIC S9(4) COMP.                                
022800 01  PARM                  PIC S9(4) COMP.                                
023000 COPY INFOSTR OF J3KLIB.                                                  
023100                                                                          
023200******************************************************************        
023300 PROCEDURE DIVISION USING SOCKET-ID SERVICE-NAME                          
023400                        PASSWORD HOST-NAME N-ERR INFO-STRING PARM.        
023500******************************************************************        
023600                                                                          
023700 1000-BEGIN.                                                              
023800D    DISPLAY THIS-PROG "1000-BEGIN".                                      
023900     MOVE ZERO TO N-ERR SOCKET-ID.                                        
024000     MOVE INFO-SERVICE-NAME TO SERVICE-NAME.                              
024100     MOVE INFO-HOST-NAME TO HOST-NAME.                                    
024200                                                                          
024300*-----Get the connection-----*                                            
024400                                                                          
024500D    DISPLAY THIS-PROG "Calling IPCGET - CONNECT-NAME=["                  
024600D        INFO-CONNECT-NAME "]".                                           
024700     MOVE 8 TO I2.                                                        
024800     MOVE ZERO TO N2.                                                     
024900     CALL INTRINSIC "IPCGET" USING                                        
025000         INFO-CONNECT-NAME I2 N2 SOCKET-ID LONG-ERROR.                    
025100     IF LONG-ERROR NOT = ZERO                                             
025200         MOVE "IPCGET" TO ERROR-CALL                                      
025300         MOVE SOCKET-ID TO ERROR-SOCKET-ID                                
025400         PERFORM 9010-IPC-CALL-ERROR                                      
025500         GO TO 1900-RETURN.                                               
025600D    MOVE SOCKET-ID TO DISP-SN4.                                          
025700D    DISPLAY THIS-PROG "Got connection SOCKET-ID=" DISP-SN4.              
025800                                                                          
025900*-----Respond to client-----*                                             
026000                                                                          
026100D    DISPLAY THIS-PROG "Respond to client".                               
026200     CALL  "PROCNUM"  USING WORK-N.                                       
026300     MOVE WORK-N TO DISP-N8.                                              
026400     MOVE "PASSED" TO WORK-X.                                             
026500     MOVE DISP-N8 TO WORK-X(7:).                                          
026600     MOVE 14 TO I2.                                                       
026700D    MOVE I2 TO DISP-SN4.                                                 
026800D    DISPLAY THIS-PROG "Sending" DISP-SN4 " bytes".                       
026900D    MOVE 1 TO I.                                                         
027000D    MOVE I2 TO L.                                                        
027100D    PERFORM UNTIL L < 1                                                  
027200D        IF L > 50                                                        
027300D            MOVE 50 TO N                                                 
027400D        ELSE                                                             
027500D            MOVE L TO N                                                  
027600D        END-IF                                                           
027700D        DISPLAY THIS-PROG "[" WORK-X(I:N) "]"                            
027800D        ADD N TO I                                                       
027900D        SUBTRACT N FROM L                                                
028000D    END-PERFORM.                                                         
028100     CALL INTRINSIC "IPCSEND" USING                                       
028200         SOCKET-ID WORK-X I2 \\ \\ LONG-ERROR.                            
028300     IF LONG-ERROR NOT = ZERO                                             
028400         MOVE "IPCSEND" TO ERROR-CALL                                     
028500         MOVE SOCKET-ID TO ERROR-SOCKET-ID                                
028600         PERFORM 9010-IPC-CALL-ERROR                                      
028700         GO TO 1900-RETURN.                                               
028800                                                                          
028900     MOVE 300 TO ACKTIMEOUT.                                              
029000     CALL "J3KREADACK" USING SOCKET-ID ACKTIMEOUT ACKBUF N-ERR.           
029100     IF N-ERR NOT = 0 GO TO 1900-RETURN.                                  
029200     IF BAD-ACK                                                           
029300        MOVE -10 TO N-ERR LONG-ERROR                                      
029400        PERFORM 9010-IPC-CALL-ERROR.                                      
029500*-----Return to caller-----*                                              
029600                                                                          
029700 1900-RETURN.                                                             
029800D    DISPLAY THIS-PROG "1900-RETURN".                                     
029900     GOBACK.                                                              
030000                                                                          
030100*-----IPC call error-----*                                                
030200                                                                          
030300 9010-IPC-CALL-ERROR.                                                     
030400D    DISPLAY THIS-PROG "9010-IPC-CALL-ERROR".                             
030500     MOVE LONG-ERROR TO N-ERR.                                            
030600D    MOVE LONG-ERROR TO DISP-SN4.                                         
030700D    MOVE ERROR-SOCKET-ID TO DISP-SN5.                                    
030800D    DISPLAY THIS-PROG "Error" DISP-SN4 " occurred calling "              
030900D        ERROR-CALL " - DISCRIPTOR" DISP-SN5.                             
031000     MOVE LONG-ERROR TO I2.                                               
031100     MOVE SPACES TO ERROR-MSG.                                            
031200     MOVE I2 TO N-ERR.                                                    
031300     INITIALIZE ERROR-MSG I.                                              
031400     CALL "J3KSOCKERR" USING N-ERR ERROR-MSG I.                           
031500     MOVE I TO N2.                                                        
031600D    IF LONG-ERROR = ZERO                                                 
031700D        DISPLAY THIS-PROG "----------IPC ERROR MESSAGE----------"        
031800D        DISPLAY ERROR-MSG(1:N2).                                         
031900                                                                          
032000 END PROGRAM J3KOPENSRVR.                                                 
032100$PAGE "J3KCLIENT - Establish a client connection"                         
033200$CONTROL SYNC32,RLFILE,LIST,DYNAMIC,OPTFEATURES=LINKALIGNED16             
033300 IDENTIFICATION DIVISION.                                                 
033400 PROGRAM-ID. J3KCLIENT.                                                   
033500 AUTHOR.     Michael Anderson.                                            
033600 DATE-COMPILED.                                                           
034600 ENVIRONMENT DIVISION.                                                    
034800 CONFIGURATION SECTION.                                                   
034900 SOURCE-COMPUTER. HP3000.                                                 
035000* SOURCE-COMPUTER. HP3000 WITH DEBUGGING MODE.                            
035100 OBJECT-COMPUTER. HP3000.                                                 
035200 SPECIAL-NAMES.                                                           
035300     CONDITION-CODE IS CC.                                                
035500 INPUT-OUTPUT SECTION.                                                    
035600 FILE-CONTROL.                                                            
035700                                                                          
035800     SELECT SERVICE-FILE ASSIGN TO "SERVICES".                            
036300 DATA DIVISION.                                                           
036700 FILE SECTION.                                                            
037000 FD  SERVICE-FILE.                                                        
037100 COPY SERVICES OF J3KLIB.                                                 
037700 WORKING-STORAGE SECTION.                                                 
038000 01  I                     PIC S9(4) COMP.                                
038100 01  I2                    PIC S9(9) COMP.                                
038200 01  J                     PIC S9(4) COMP.                                
038300 01  J2                    PIC S9(9) COMP.                                
038400 01  L                     PIC S9(4) COMP.                                
038500 01  L2                    PIC S9(9) COMP.                                
038600 01  ACKTIMEOUT            PIC S9(4) COMP.                                
038700 01  ACKBUF                PIC X VALUE SPACES.                            
038800     88 GOOD-ACK           VALUE "Y".                                     
038900     88 BAD-ACK            VALUE "N".                                     
039000 01  N                     PIC S9(4) COMP.                                
039100 01  N2                    PIC S9(9) COMP.                                
039200                                                                          
039300 01  FILE-STATUS           PIC XX.                                        
039400                                                                          
039500 01  THIS-PROG             PIC X(10) VALUE "J3KCLIENT ".                  
039600                                                                          
039700 01  ACTUAL-HOST           PIC X(8)  VALUE SPACES.                        
039800 01  SHIFT-STRANG          PIC X(8)  VALUE SPACES.                        
039900                                                                          
040000 01  TCP-ADDRESS-N         PIC S9(9) COMP.                                
040100 01  FILLER REDEFINES TCP-ADDRESS-N.                                      
040200     02  FILLER            PIC XX.                                        
040300     02  TCP-ADDRESS       PIC XX.                                        
040400                                                                          
040500 01  SERV-FILE-STMT.                                                      
040600     02  FILLER            PIC X(20) VALUE "FILE SERVICES=SERVIC".        
040700     02  FILLER            PIC X(18) VALUE "ES.PUB.J3K;SHR ".             
040800     02  FILLER            PIC X VALUE %15.                               
040900                                                                          
041000 01  SERV-RESET-STMT.                                                     
041100     02  FILLER            PIC X(15) VALUE "RESET SERVICES ".             
041200     02  FILLER            PIC X VALUE %15.                               
041300                                                                          
042400 01  DEST-SOCKET-ID       PIC S9(9) COMP.                                 
042500                                                                          
042600 01  ERROR-CALL            PIC X(10).                                     
042700 01  ERROR-SOCKET-ID      PIC S9(9) COMP.                                 
042800 01  ERROR-MSG             PIC X(80).                                     
042900                                                                          
043000 01  LONG-ERROR            PIC S9(9) COMP VALUE ZERO.                     
043100 01  FILLER REDEFINES LONG-ERROR.                                         
043200     02  FILLER            PIC XX.                                        
043300     02  SHORT-ERROR       PIC S9(4) COMP.                                
043400                                                                          
043500 01  WORK-NX.                                                             
043600     02  WORK-N            PIC S9(4) COMP.                                
043700                                                                          
043800 01  ASCII-VALUE           PIC S9(4) COMP VALUE 0.                        
043900 01  CHARACTER-ARRAY REDEFINES ASCII-VALUE.                               
044000     02 FIRST-BYTE         PIC X.                                         
044100     02 ASCII-CHAR         PIC X.                                         
044200                                                                          
044300 01  WORK-X                PIC X(80).                                     
044400                                                                          
044500 01  DISP-N2               PIC 99.                                        
044600 01  DISP-N3               PIC 999.                                       
044700 01  DISP-N4               PIC 9(4).                                      
044800 01  DISP-SN4              PIC ----9.                                     
044900 01  DISP-SN5              PIC -----9.                                    
045000                                                                          
045100 01  RECV-LEN            PIC S9(4) COMP.                                  
045200 01  RECV-LOC            PIC S9(4) COMP.                                  
045300                                                                          
045400 01  RESP-BUFFER.                                                         
045500     02  RESP-PASSED-FAILED PIC X(6).                                     
045600     02  RESP-PIN-NO        PIC 9(8).                                     
045700                                                                          
045800 COPY SECURITY OF J3KLIB REPLACING ==EXTERNAL== BY == ==.                 
045900*============================================*                            
046000 LINKAGE SECTION.                                                         
046100*============================================*                            
046200                                                                          
046300 01  SOCKET-ID          PIC S9(9) COMP SYNC.                              
046400                                                                          
046500 01  SERVICE-NAME          PIC X(8).                                      
046600                                                                          
046700 01  PASSWORD              PIC X(8).                                      
046800                                                                          
046900 01  HOST-NAME             PIC X(8).                                      
047000                                                                          
047100 01  N-ERR                 PIC S9(4) COMP.                                
047200                                                                          
047300******************************************************************        
047400 PROCEDURE DIVISION USING SOCKET-ID SERVICE-NAME                          
047500                                         PASSWORD HOST-NAME N-ERR.        
047600******************************************************************        
047700                                                                          
047800 1000-BEGIN.                                                              
047900*-----SERVICE-NAME must be upper case-----------*                         
048000     MOVE SERVICE-NAME TO SHIFT-STRANG.                                   
048100     PERFORM VARYING I FROM 1 BY 1 UNTIL I > 8                            
048200      INITIALIZE ASCII-VALUE                                              
048300      MOVE SHIFT-STRANG(I:1) TO ASCII-CHAR                                
048400      IF ASCII-VALUE IS GREATER THAN 96 AND LESS THAN 123                 
048500         SUBTRACT 32 FROM ASCII-VALUE                                     
048600      END-IF                                                              
048700      MOVE ASCII-CHAR TO SHIFT-STRANG(I:1)                                
048800     END-PERFORM.                                                         
048900     IF SHIFT-STRANG NOT = SERVICE-NAME                                   
049000D       DISPLAY "Service name " QUOTE SERVICE-NAME QUOTE                  
049100D               " has been Upshifted --> "                                
049200D               QUOTE SHIFT-STRANG QUOTE                                  
049300        MOVE SHIFT-STRANG TO SERVICE-NAME.                                
049400*-----HOST-NAME must be upper case-----------*                            
049500     MOVE HOST-NAME TO SHIFT-STRANG.                                      
049600     PERFORM VARYING I FROM 1 BY 1 UNTIL I > 8                            
049700      INITIALIZE ASCII-VALUE                                              
049800      MOVE SHIFT-STRANG(I:1) TO ASCII-CHAR                                
049900      IF ASCII-VALUE IS GREATER THAN 96 AND LESS THAN 123                 
050000         SUBTRACT 32 FROM ASCII-VALUE                                     
050100      END-IF                                                              
050200      MOVE ASCII-CHAR TO SHIFT-STRANG(I:1)                                
050300     END-PERFORM.                                                         
050400     IF SHIFT-STRANG NOT = HOST-NAME                                      
050500D       DISPLAY "Host name " QUOTE HOST-NAME QUOTE                        
050600D               " has been Upshifted --> "                                
050700D               QUOTE SHIFT-STRANG QUOTE                                  
050800        MOVE SHIFT-STRANG TO HOST-NAME.                                   
050900D    DISPLAY THIS-PROG "1000-BEGIN - SERVICE-NAME=["                      
051000D        SERVICE-NAME "]".                                                
051100     MOVE ZERO TO N-ERR SOCKET-ID.                                        
051200                                                                          
051300*-----Look up SERVICE-NAME in SERVICES file-----*                         
051400                                                                          
051500*    Open SERVICES file                                                   
051600                                                                          
051700     CALL INTRINSIC "COMMAND" USING SERV-FILE-STMT I N.                   
051800     IF I NOT = ZERO                                                      
051900D        MOVE I TO DISP-SN4                                               
052000D        DISPLAY THIS-PROG "Error" DISP-SN4                               
052100D            " occurred doing FILE command for SERVICES file"             
052200         MOVE -3 TO LONG-ERROR N-ERR                                      
052300         PERFORM 9010-IPC-CALL-ERROR                                      
052400         GO TO 1900-RETURN.                                               
052500     OPEN INPUT SERVICE-FILE.                                             
052600                                                                          
052700*    Read through SERVICES file looking for SERVICE-NAME                  
052800                                                                          
052900 1100-READ-SERVICES.                                                      
053000D    DISPLAY THIS-PROG "1100-READ-SERVICES".                              
053100     READ SERVICE-FILE AT END                                             
053200D        DISPLAY THIS-PROG "Unable to find service"                       
053300         MOVE -4 TO LONG-ERROR N-ERR                                      
053400         PERFORM 9010-IPC-CALL-ERROR                                      
053500         GO TO 1900-RETURN.                                               
053600                                                                          
053700     IF ( SERV-SERVICE-NAME NOT = SERVICE-NAME )                          
053800     OR ( SERV-HOST         NOT = SPACES AND HOST-NAME  )                 
053900     OR ( SERV-SERVICE-TYPE NOT = "C" )                                   
054000        GO TO 1100-READ-SERVICES.                                         
054100                                                                          
054800     MOVE SERV-TCP-ADDRESS TO TCP-ADDRESS-N.                              
058800                                                                          
058900*-----Get destination SOCKET-ID-----*                                     
059000                                                                          
059100D    DISPLAY THIS-PROG "Calling IPCDEST - TCP-ADDRESS="                   
059200D        SERV-TCP-ADDRESS.                                                
059300     MOVE 8 TO L2.                                                        
059500     MOVE HOST-NAME TO ACTUAL-HOST                                        
059900     PERFORM UNTIL L2 = 1 OR ACTUAL-HOST(L2:1) NOT = SPACE                
060000         SUBTRACT 1 FROM L2                                               
060100     END-PERFORM.                                                         
060200     CALL INTRINSIC "IPCDEST" USING \3\ ACTUAL-HOST L2 \4\                
060300         TCP-ADDRESS \2\ \\ \\ DEST-SOCKET-ID LONG-ERROR.                 
060400     IF LONG-ERROR NOT = ZERO                                             
060500         MOVE "IPCDEST" TO ERROR-CALL                                     
060600         MOVE DEST-SOCKET-ID TO ERROR-SOCKET-ID                           
060700         PERFORM 9010-IPC-CALL-ERROR                                      
060800         GO TO 1900-RETURN.                                               
060900D    MOVE DEST-SOCKET-ID TO DISP-SN4.                                     
061000D    DISPLAY THIS-PROG "Found DEST-SOCKET-ID=" DISP-SN4.                  
061100                                                                          
061200*-----Connect with the remote host-----*                                  
061300                                                                          
061400D    DISPLAY THIS-PROG "Calling IPCCONNECT".                              
061500     MOVE -1 TO I2.                                                       
061600     CALL INTRINSIC "IPCCONNECT" USING                                    
061700         I2 DEST-SOCKET-ID \\ \\ SOCKET-ID LONG-ERROR.                    
061800     IF LONG-ERROR NOT = ZERO                                             
061900         MOVE "IPCCONNECT" TO ERROR-CALL                                  
062000         MOVE DEST-SOCKET-ID TO ERROR-SOCKET-ID                           
062100         PERFORM 9010-IPC-CALL-ERROR                                      
062200         GO TO 1900-RETURN.                                               
062300D    MOVE SOCKET-ID TO DISP-SN4.                                          
062400D    DISPLAY THIS-PROG "Connected SOCKET-ID=" DISP-SN4.                   
062500                                                                          
062600*-----Do IPCRECV to complete the connection-----*                         
062700                                                                          
062800*    Set timeout to 5 minutes                                             
062900                                                                          
063000D    DISPLAY THIS-PROG "Set timeout to 5 minutes".                        
063100     MOVE 3000 TO WORK-N.                                                 
063200     CALL INTRINSIC "IPCCONTROL" USING                                    
063300         SOCKET-ID \3\ WORK-NX \2\ \\ \\ \\ LONG-ERROR.                   
063400     IF LONG-ERROR NOT = ZERO                                             
063500         MOVE "IPCCONTROL" TO ERROR-CALL                                  
063600         MOVE SOCKET-ID TO ERROR-SOCKET-ID                                
063700         PERFORM 9010-IPC-CALL-ERROR                                      
063800         GO TO 1900-RETURN.                                               
063900                                                                          
064000*    Call IPCRECV                                                         
064100                                                                          
064200D    DISPLAY THIS-PROG "Call IPCRECV".                                    
064300     MOVE SPACES TO RESP-BUFFER.                                          
064400     MOVE ZERO TO RECV-LEN.                                               
064500     MOVE RECV-LEN TO I2                                                  
064600     CALL INTRINSIC "IPCRECV" USING SOCKET-ID                             
064700         RESP-BUFFER I2 \\ \\ LONG-ERROR                                  
064800     IF LONG-ERROR NOT = ZERO                                             
064900         MOVE "IPCRECV" TO ERROR-CALL                                     
065000         MOVE SOCKET-ID TO ERROR-SOCKET-ID                                
065100         PERFORM 9010-IPC-CALL-ERROR                                      
065200         GO TO 1900-RETURN.                                               
065300D        DISPLAY THIS-PROG "Connection complete".                         
065400                                                                          
065500*-----Send the security redord-----*                                      
065600                                                                          
065700D    DISPLAY THIS-PROG "Send security record".                            
065800     MOVE SPACES TO SECURITY-RECORD.                                      
065900     MOVE "SECURITY" TO SEC-ID.                                           
066000     MOVE "USERNAME" TO SEC-USER-NAME.                                    
066100     MOVE "PASSWORD" TO SEC-PASSWORD.                                     
066200     MOVE SERVICE-NAME TO SEC-SERVICE-NAME.                               
066300     CALL INTRINSIC "WHO" USING \\ \\ \\ \\ \\ \\ \\ I.                   
066400     MOVE I TO SEC-DEVICE-NO.                                             
066500     CALL INTRINSIC "PROCINFO" USING I N \0\ \1\ WORK-NX.                 
066600     MOVE WORK-N TO SEC-PIN-NO.                                           
066700     MOVE HOST-NAME TO SEC-HOST.                                          
066800     CALL INTRINSIC ".LEN." USING SECURITY-RECORD GIVING I2.              
066900     MOVE I2 TO DISP-SN4.                                                 
067000D    DISPLAY THIS-PROG "Sending" DISP-SN4 " bytes".                       
067100D    MOVE 1 TO I.                                                         
067200D    MOVE I2 TO L.                                                        
067300D    PERFORM UNTIL L < 1                                                  
067400D        IF L > 60                                                        
067500D            MOVE 60 TO N                                                 
067600D        ELSE                                                             
067700D            MOVE L TO N                                                  
067800D        END-IF                                                           
067900D        DISPLAY THIS-PROG "[" SECURITY-RECORD(I:N) "]"                   
068000D        ADD N TO I                                                       
068100D        SUBTRACT N FROM L                                                
068200D    END-PERFORM.                                                         
068300     CALL INTRINSIC "IPCSEND" USING                                       
068400         SOCKET-ID SECURITY-RECORD I2 \\ \\ LONG-ERROR.                   
068500     IF LONG-ERROR NOT = ZERO                                             
068600         MOVE "IPCSEND" TO ERROR-CALL                                     
068700         MOVE SOCKET-ID TO ERROR-SOCKET-ID                                
068800         PERFORM 9010-IPC-CALL-ERROR                                      
068900         GO TO 1900-RETURN.                                               
069000*-----Wait for ack. from the remote process ------*                       
069100     MOVE 300 TO ACKTIMEOUT.                                              
069200     CALL "J3KREADACK" USING SOCKET-ID ACKTIMEOUT ACKBUF N-ERR.           
069300     IF N-ERR NOT = 0 GO TO 1900-RETURN.                                  
069400     IF BAD-ACK                                                           
069500        MOVE -10 TO LONG-ERROR N-ERR                                      
069600        PERFORM 9010-IPC-CALL-ERROR                                       
069700        GO TO 1900-RETURN.                                                
069800                                                                          
069900                                                                          
070000*-----Get response-----*                                                  
070100                                                                          
070200*    Set timeout to 5 minutes                                             
070300                                                                          
070400D    DISPLAY THIS-PROG "Set timeout to 5 minutes".                        
070500     MOVE 3000 TO WORK-N.                                                 
070600     CALL INTRINSIC "IPCCONTROL" USING                                    
070700         SOCKET-ID \3\ WORK-NX \2\ \\ \\ \\ LONG-ERROR.                   
070800     IF LONG-ERROR NOT = ZERO                                             
070900         MOVE "IPCCONTROL" TO ERROR-CALL                                  
071000         MOVE SOCKET-ID TO ERROR-SOCKET-ID                                
071100         PERFORM 9010-IPC-CALL-ERROR                                      
071200         GO TO 1900-RETURN.                                               
071300                                                                          
071400*    Receive the response                                                 
071500                                                                          
071600D    DISPLAY THIS-PROG "Receive the response".                            
071700     MOVE SPACES TO RESP-BUFFER.                                          
071800     MOVE 14 TO RECV-LEN.                                                 
071900     MOVE 1 TO RECV-LOC.                                                  
072000     PERFORM UNTIL RECV-LEN LESS THAN 1                                   
072100D        MOVE RECV-LEN TO DISP-SN4                                        
072200D        DISPLAY THIS-PROG "Receiving" DISP-SN4 " bytes"                  
072300         MOVE RECV-LEN TO I2                                              
072400         CALL INTRINSIC "IPCRECV" USING SOCKET-ID                         
072500             RESP-BUFFER(RECV-LOC:) I2 \\ \\ LONG-ERROR                   
072600         IF LONG-ERROR NOT = ZERO                                         
072700             MOVE "IPCRECV" TO ERROR-CALL                                 
072800             MOVE SOCKET-ID TO ERROR-SOCKET-ID                            
072900             PERFORM 9010-IPC-CALL-ERROR                                  
073000             GO TO 1900-RETURN                                            
073100         END-IF                                                           
073200D        MOVE I2 TO DISP-SN4                                              
073300D        DISPLAY THIS-PROG "Received" DISP-SN4 " bytes"                   
073400D        MOVE RECV-LOC TO I                                               
073500D        MOVE I2 TO L                                                     
073600D        PERFORM UNTIL L < 1                                              
073700D            IF L > 60                                                    
073800D                MOVE 60 TO N                                             
073900D            ELSE                                                         
074000D                MOVE L TO N                                              
074100D            END-IF                                                       
074200D            DISPLAY THIS-PROG "[" RESP-BUFFER(I:N) "]"                   
074300D            ADD N TO I                                                   
074400D            SUBTRACT N FROM L                                            
074500D        END-PERFORM                                                      
074600         ADD I2 TO RECV-LOC                                               
074700         SUBTRACT I2 FROM RECV-LEN                                        
074800     END-PERFORM.                                                         
074900*-----Send ack to the remote process -----------                          
075000     MOVE "Y" TO ACKBUF.                                                  
075100     CALL "J3KWRITACK" USING SOCKET-ID ACKBUF N-ERR.                      
075200                                                                          
075300     IF RESP-PASSED-FAILED = "PASSED"                                     
075400D        DISPLAY THIS-PROG "Server PIN number=" RESP-PIN-NO               
075500         GO TO 1900-RETURN.                                               
075600                                                                          
075700*-----Failed - get error number-----*                                     
075800                                                                          
075900D    DISPLAY THIS-PROG "Failed! Security on remote.".                     
076000     MOVE -2   TO LONG-ERROR N-ERR.                                       
076100     PERFORM 9010-IPC-CALL-ERROR.                                         
076200                                                                          
076300*-----Return to caller-----*                                              
076400                                                                          
076500 1900-RETURN.                                                             
076600D    DISPLAY THIS-PROG "1900-RETURN".                                     
076700     CALL INTRINSIC "COMMAND" USING SERV-RESET-STMT I N.                  
076800     GOBACK.                                                              
076900                                                                          
077000*-----IPC call error-----*                                                
077100                                                                          
077200 9010-IPC-CALL-ERROR.                                                     
077300D    DISPLAY THIS-PROG "9010-IPC-CALL-ERROR".                             
077400     MOVE LONG-ERROR TO N-ERR.                                            
077500     MOVE LONG-ERROR TO DISP-SN4.                                         
077600     MOVE ERROR-SOCKET-ID TO DISP-SN5.                                    
077700D    DISPLAY THIS-PROG "Error" DISP-SN4 " occurred calling "              
077800D        ERROR-CALL " - DISCRIPTOR" DISP-SN5.                             
077900     MOVE LONG-ERROR TO I2.                                               
078000     MOVE SPACES TO ERROR-MSG.                                            
078100     MOVE I2 TO N-ERR.                                                    
078200     INITIALIZE ERROR-MSG I.                                              
078300     CALL "J3KSOCKERR" USING N-ERR ERROR-MSG I.                           
078400     MOVE I TO N2.                                                        
078500D    IF LONG-ERROR = ZERO                                                 
078600D        DISPLAY THIS-PROG "----------IPC ERROR MESSAGE----------"        
078700D        DISPLAY ERROR-MSG(1:N2).                                         
078800                                                                          
078900 END PROGRAM J3KCLIENT.                                                   
079000$PAGE "J3KWRITSOCK - Send data to a remote process"                       
080100$CONTROL SYNC32,RLFILE,LIST,DYNAMIC,OPTFEATURES=LINKALIGNED16             
080200 IDENTIFICATION DIVISION.                                                 
080300 PROGRAM-ID. J3KWRITSOCK.                                                 
080400 AUTHOR.     Michael Anderson.                                            
080600 DATE-COMPILED.                                                           
081500 ENVIRONMENT DIVISION.                                                    
081600                                                                          
081700 CONFIGURATION SECTION.                                                   
081800 SOURCE-COMPUTER. HP3000.                                                 
081900* SOURCE-COMPUTER. HP3000 WITH DEBUGGING MODE.                            
082000 OBJECT-COMPUTER. HP3000.                                                 
082100 SPECIAL-NAMES.                                                           
082200     CONDITION-CODE IS CC.                                                
082500 DATA DIVISION.                                                           
082900 WORKING-STORAGE SECTION.                                                 
083200 01  I                     PIC S9(4) COMP.                                
083300 01  I2                    PIC S9(9) COMP.                                
083400 01  L                     PIC S9(4) COMP.                                
083500 01  N                     PIC S9(4) COMP.                                
083600 01  N2                    PIC S9(9) COMP.                                
083700                                                                          
083800 01  THIS-PROG             PIC X(12) VALUE "J3KWRITSOCK ".                
083900                                                                          
084000 01  ACKTIMEOUT            PIC S9(4) COMP.                                
084100 01  ACKBUF                PIC X VALUE SPACES.                            
084200     88 GOOD-ACK           VALUE "Y".                                     
084300     88 BAD-ACK            VALUE "N".                                     
084400                                                                          
084500 01  ACTL-LEN              PIC 9(4) COMP.                                 
084600                                                                          
084700 01  WORK-NX.                                                             
084800     02  WORK-N            PIC S9(4) COMP.                                
084900                                                                          
085000 01  ERROR-CALL            PIC X(10).                                     
085100 01  ERROR-SOCKET-ID      PIC S9(9) COMP.                                 
085200 01  ERROR-MSG             PIC X(80).                                     
085300                                                                          
085400 01  LONG-ERROR            PIC S9(9) COMP VALUE ZERO.                     
085500 01  FILLER REDEFINES LONG-ERROR.                                         
085600     02  FILLER            PIC XX.                                        
085700     02  SHORT-ERROR       PIC S9(4) COMP.                                
085800                                                                          
085900 01  DISP-N2               PIC 99.                                        
086000 01  DISP-N3               PIC 999.                                       
086100 01  DISP-SN4              PIC ----9.                                     
086200 01  DISP-SN5              PIC -----9.                                    
086300 01  DISP-SN9              PIC ---------9.                                
086400                                                                          
086500*==================================*                                      
086600 LINKAGE SECTION.                                                         
086700*==================================*                                      
086800                                                                          
086900 01  SOCKET-ID            PIC S9(9) COMP SYNC.                            
087000                                                                          
087100 01  DATA-LEN              PIC S9(4) COMP.                                
087200                                                                          
087300 01  DATA-BUFFER           PIC X(4096).                                   
087400                                                                          
087500 01  N-ERR                 PIC S9(4) COMP.                                
087600                                                                          
087700******************************************************************        
087800 PROCEDURE DIVISION USING SOCKET-ID DATA-LEN DATA-BUFFER N-ERR.           
087900******************************************************************        
088000                                                                          
088100 1000-BEGIN.                                                              
088200D    DISPLAY THIS-PROG "1000-BEGIN".                                      
088300D    MOVE SOCKET-ID TO DISP-SN9.                                          
088400D    DISPLAY THIS-PROG "SOCKET-ID: " DISP-SN9.                            
088500     MOVE ZERO TO N-ERR.                                                  
088600                                                                          
088700                                                                          
088800*-----Data-Len cannot exceed 4096 characters-----*                        
088900                                                                          
089000     IF DATA-LEN > 4096                                                   
089100        MOVE -1 TO N-ERR                                                  
089200        PERFORM 9010-IPC-CALL-ERROR                                       
089300        GO TO 1900-RETURN.                                                
089400                                                                          
089500*-----Send the length-----*                                               
089600                                                                          
089700     MOVE DATA-LEN TO DISP-SN4.                                           
089800D    DISPLAY THIS-PROG "Sending length" DISP-SN4.                         
089900     MOVE DATA-LEN TO WORK-N.                                             
090000     MOVE 2 TO I2.                                                        
090100     CALL INTRINSIC "IPCSEND" USING                                       
090200         SOCKET-ID WORK-NX I2 \\ \\ LONG-ERROR.                           
090300     IF LONG-ERROR NOT = ZERO                                             
090400         MOVE "IPCSEND" TO ERROR-CALL                                     
090500         MOVE SOCKET-ID TO ERROR-SOCKET-ID                                
090600         PERFORM 9010-IPC-CALL-ERROR                                      
090700         GO TO 1900-RETURN.                                               
090800                                                                          
090900*-----Send the data-----*                                                 
091000                                                                          
091100     MOVE DATA-LEN TO ACTL-LEN.                                           
091200     MOVE ACTL-LEN TO DISP-SN4.                                           
091300D    DISPLAY THIS-PROG "Sending" DISP-SN4 " bytes".                       
091400D    MOVE 1 TO I.                                                         
091500D    MOVE ACTL-LEN TO L.                                                  
091600D    PERFORM UNTIL L < 1                                                  
091700D        IF L > 60                                                        
091800D            MOVE 60 TO N                                                 
091900D        ELSE                                                             
092000D            MOVE L TO N                                                  
092100D        END-IF                                                           
092200D        DISPLAY THIS-PROG "[" DATA-BUFFER(I:N) "]"                       
092300D        ADD N TO I                                                       
092400D        SUBTRACT N FROM L                                                
092500D    END-PERFORM.                                                         
092600     MOVE ACTL-LEN TO I2.                                                 
092700     CALL INTRINSIC "IPCSEND" USING                                       
092800         SOCKET-ID DATA-BUFFER I2 \\ \\ LONG-ERROR.                       
092900     IF LONG-ERROR NOT = ZERO                                             
093000         MOVE "IPCSEND" TO ERROR-CALL                                     
093100         MOVE SOCKET-ID TO ERROR-SOCKET-ID                                
093200         PERFORM 9010-IPC-CALL-ERROR.                                     
093300                                                                          
093400                                                                          
093500*-------- WAIT FOR ACK FROM REMOTE PROCESS -------------                  
093600     MOVE 300 TO ACKTIMEOUT.                                              
093700     CALL "J3KREADACK" USING SOCKET-ID ACKTIMEOUT ACKBUF N-ERR.           
093800     IF N-ERR NOT = 0 GO TO 1900-RETURN.                                  
093900     IF BAD-ACK                                                           
094000        MOVE -10 TO N-ERR LONG-ERROR                                      
094100        PERFORM 9010-IPC-CALL-ERROR.                                      
094200                                                                          
094300*-----Return to caller-----*                                              
094400                                                                          
094500 1900-RETURN.                                                             
094600D    DISPLAY THIS-PROG " 1900-RETURN".                                    
094700     GOBACK.                                                              
094800                                                                          
094900*-----IPC call error-----*                                                
095000                                                                          
095100 9010-IPC-CALL-ERROR.                                                     
095200D    DISPLAY THIS-PROG "9010-IPC-CALL-ERROR".                             
095300     MOVE LONG-ERROR TO N-ERR.                                            
095400     MOVE LONG-ERROR TO DISP-SN4.                                         
095500     MOVE ERROR-SOCKET-ID TO DISP-SN5.                                    
095600D    DISPLAY THIS-PROG " Error" DISP-SN4 " occurred calling "             
095700D        ERROR-CALL " - DISCRIPTOR" DISP-SN5.                             
095800     MOVE LONG-ERROR TO I2.                                               
095900     MOVE SPACES TO ERROR-MSG.                                            
096000     MOVE I2 TO N-ERR.                                                    
096100     INITIALIZE ERROR-MSG I.                                              
096200     CALL "J3KSOCKERR" USING N-ERR ERROR-MSG I.                           
096300     MOVE I TO N2.                                                        
096400D    IF LONG-ERROR = ZERO                                                 
096500D        DISPLAY THIS-PROG "----------IPC ERROR MESSAGE----------"        
096600D        DISPLAY ERROR-MSG(1:N2).                                         
096700                                                                          
096800 END PROGRAM J3KWRITSOCK.                                                 
096900$PAGE "J3KREADSOCK - Receive data from a remote process"                  
098000$CONTROL SYNC32,RLFILE,LIST,DYNAMIC,OPTFEATURES=LINKALIGNED16             
098100 IDENTIFICATION DIVISION.                                                 
098200 PROGRAM-ID. J3KREADSOCK.                                                 
098300 AUTHOR.     Michael Anderson.                                            
098400 DATE-COMPILED.                                                           
099400 ENVIRONMENT DIVISION.                                                    
099500                                                                          
099600 CONFIGURATION SECTION.                                                   
099700 SOURCE-COMPUTER. HP3000.                                                 
099800* SOURCE-COMPUTER. HP3000 WITH DEBUGGING MODE.                            
099900 OBJECT-COMPUTER. HP3000.                                                 
100000 SPECIAL-NAMES.                                                           
100100     CONDITION-CODE IS CC.                                                
100400 DATA DIVISION.                                                           
100800 WORKING-STORAGE SECTION.                                                 
101100 01  I                     PIC S9(4) COMP.                                
101200 01  I2                    PIC S9(9) COMP.                                
101300 01  L                     PIC S9(4) COMP.                                
101400 01  N                     PIC S9(4) COMP.                                
101500 01  N2                    PIC S9(9) COMP.                                
101600                                                                          
101700 01  THIS-PROG             PIC X(12) VALUE "J3KREADSOCK ".                
101800                                                                          
101900 01  ACKTIMEOUT            PIC S9(4) COMP.                                
102000 01  ACKBUF                PIC X VALUE SPACES.                            
102100     88 GOOD-ACK           VALUE "Y".                                     
102200     88 BAD-ACK            VALUE "N".                                     
102300                                                                          
102400 01  RECV-LEN              PIC 9(4) COMP.                                 
102500 01  RECV-LOC              PIC S9(4) COMP.                                
102600                                                                          
102700 01  ACTL-LEN              PIC 9(4) COMP.                                 
102800 01  MAX-LEN               PIC 9(4) COMP.                                 
102900                                                                          
103000 01  LEN-X.                                                               
103100     02  LEN-N             PIC S9(4) COMP.                                
103200                                                                          
103300 01  WORK-NX.                                                             
103400     02  WORK-N            PIC S9(4) COMP.                                
103500                                                                          
103600 01  WORK-X                PIC X(80).                                     
103700                                                                          
103800 01  ERROR-CALL            PIC X(10).                                     
103900 01  ERROR-SOCKET-ID      PIC S9(9) COMP.                                 
104000 01  ERROR-MSG             PIC X(80).                                     
104100                                                                          
104200 01  LONG-ERROR            PIC S9(9) COMP VALUE ZERO.                     
104300 01  FILLER REDEFINES LONG-ERROR.                                         
104400     02  FILLER            PIC XX.                                        
104500     02  SHORT-ERROR       PIC S9(4) COMP.                                
104600                                                                          
104700 01  DISP-N2               PIC 99.                                        
104800 01  DISP-N3               PIC 999.                                       
104900 01  DISP-SN4              PIC ----9.                                     
105000 01  DISP-SN5              PIC -----9.                                    
105100 01  DISP-SN9              PIC ---------9.                                
105200                                                                          
105300*==================================*                                      
105400 LINKAGE SECTION.                                                         
105500*==================================*                                      
105600                                                                          
105700 01  SOCKET-ID            PIC S9(9) COMP SYNC.                            
105800                                                                          
105900 01  DATA-LEN              PIC S9(4) COMP.                                
106000                                                                          
106100 01  DATA-BUFFER           PIC X(4096).                                   
106200                                                                          
106300 01  N-ERR                 PIC S9(4) COMP.                                
106400                                                                          
106500******************************************************************        
106600 PROCEDURE DIVISION USING SOCKET-ID DATA-LEN DATA-BUFFER N-ERR.           
106700******************************************************************        
106800                                                                          
106900 1000-BEGIN.                                                              
107000D    DISPLAY THIS-PROG "1000-BEGIN".                                      
107100D    MOVE SOCKET-ID TO DISP-SN9.                                          
107200D    DISPLAY THIS-PROG "SOCKET-ID: " DISP-SN9.                            
107300*-----Data-Len cannot be < 1 character-----*                              
107400                                                                          
107500     IF DATA-LEN < 1                                                      
107600        MOVE -5 TO LONG-ERROR N-ERR                                       
107700        PERFORM 9010-IPC-CALL-ERROR                                       
107800        GO TO 1900-RETURN.                                                
107900                                                                          
108000     MOVE ZERO TO N-ERR.                                                  
108100                                                                          
108200*-----Data-Len cannot exceed 4096 characters-----*                        
108300                                                                          
108400     IF DATA-LEN > 4096                                                   
108500        MOVE -6 TO LONG-ERROR N-ERR                                       
108600        PERFORM 9010-IPC-CALL-ERROR                                       
108700        GO TO 1900-RETURN.                                                
108800                                                                          
108900                                                                          
109000                                                                          
109100*-----Get the length-----*                                                
109200                                                                          
109300*    Set timeout to infinity.                                             
109400                                                                          
109500D    DISPLAY THIS-PROG "Set timeout to infinity".                         
109600     MOVE ZERO TO WORK-N.                                                 
109700     CALL INTRINSIC "IPCCONTROL" USING                                    
109800         SOCKET-ID \3\ WORK-NX \2\ \\ \\ \\ LONG-ERROR.                   
109900     IF LONG-ERROR NOT = ZERO                                             
110000         MOVE "IPCCONTROL" TO ERROR-CALL                                  
110100         MOVE SOCKET-ID TO ERROR-SOCKET-ID                                
110200         PERFORM 9010-IPC-CALL-ERROR                                      
110300         GO TO 1900-RETURN.                                               
110400                                                                          
110500*    Receive the length                                                   
110600                                                                          
110700D    DISPLAY THIS-PROG "Receive the length".                              
110800     MOVE DATA-LEN TO MAX-LEN.                                            
110900     MOVE 2 TO I2.                                                        
111000     CALL INTRINSIC "IPCRECV" USING                                       
111100         SOCKET-ID LEN-X I2 \\ \\ LONG-ERROR.                             
111200     IF LONG-ERROR NOT = ZERO                                             
111300         MOVE "IPCRECV" TO ERROR-CALL                                     
111400         MOVE SOCKET-ID TO ERROR-SOCKET-ID                                
111500         PERFORM 9010-IPC-CALL-ERROR                                      
111600         GO TO 1900-RETURN.                                               
111700D    MOVE 2 TO I.                                                         
111800D    CALL "J3KSHOW" USING LEN-X I.                                        
111900     MOVE LEN-N TO DISP-SN4.                                              
112000D    DISPLAY THIS-PROG "Length=" DISP-SN4 " bytes".                       
112100     MOVE LEN-N TO DATA-LEN ACTL-LEN.                                     
112200     IF LEN-N = -9999                                                     
112300         GO TO 1900-RETURN                                                
112400     ELSE                                                                 
112500         IF ACTL-LEN GREATER THAN MAX-LEN                                 
112600D            MOVE ACTL-LEN TO DISP-SN4                                    
112700D            DISPLAY THIS-PROG "Receive length=" DISP-SN4                 
112800D            MOVE MAX-LEN TO DISP-SN4                                     
112900D            DISPLAY THIS-PROG "Maximum length=" DISP-SN4                 
113000             MOVE -7 TO LONG-ERROR N-ERR                                  
113100             PERFORM 9010-IPC-CALL-ERROR.                                 
113200                                                                          
113300*-----Get the data-----*                                                  
113400                                                                          
113500*    Set timeout to 5 minutes                                             
113600                                                                          
113700D    DISPLAY THIS-PROG "Set timeout to 5 minutes".                        
113800     MOVE 3000 TO WORK-N.                                                 
113900     CALL INTRINSIC "IPCCONTROL" USING                                    
114000         SOCKET-ID \3\ WORK-NX \2\ \\ \\ \\ LONG-ERROR.                   
114100     IF LONG-ERROR NOT = ZERO                                             
114200         MOVE "IPCCONTROL" TO ERROR-CALL                                  
114300         MOVE SOCKET-ID TO ERROR-SOCKET-ID                                
114400         PERFORM 9010-IPC-CALL-ERROR                                      
114500         GO TO 1900-RETURN.                                               
114600                                                                          
114700*    Receive the data                                                     
114800                                                                          
114900D    DISPLAY THIS-PROG "Receive the data".                                
115000D    DISPLAY THIS-PROG "MAX-LEN=[" MAX-LEN "]".                           
115100D    DISPLAY THIS-PROG "ACTL-LEN=[" ACTL-LEN "]".                         
115200     MOVE SPACES TO DATA-BUFFER(1:MAX-LEN).                               
115300     IF ACTL-LEN GREATER THAN MAX-LEN                                     
115400         MOVE MAX-LEN TO RECV-LEN                                         
115500     ELSE                                                                 
115600         MOVE ACTL-LEN TO RECV-LEN.                                       
115700     IF RECV-LEN = ZERO                                                   
115800        GO TO 1900-RETURN.                                                
115900     MOVE 1 TO RECV-LOC.                                                  
116000     PERFORM UNTIL RECV-LEN LESS THAN 1                                   
116100D        MOVE RECV-LEN TO DISP-SN4                                        
116200D        DISPLAY THIS-PROG "Receiving" DISP-SN4 " bytes"                  
116300         MOVE RECV-LEN TO I2                                              
116400         CALL INTRINSIC "IPCRECV" USING SOCKET-ID                         
116500             DATA-BUFFER(RECV-LOC:) I2 \\ \\ LONG-ERROR                   
116600         IF LONG-ERROR NOT = ZERO                                         
116700             MOVE "IPCRECV" TO ERROR-CALL                                 
116800             MOVE SOCKET-ID TO ERROR-SOCKET-ID                            
116900             PERFORM 9010-IPC-CALL-ERROR                                  
117000             GO TO 1900-RETURN                                            
117100         END-IF                                                           
117200D        MOVE I2 TO DISP-SN4                                              
117300D        DISPLAY THIS-PROG "Received" DISP-SN4 " bytes"                   
117400D        MOVE I2 TO I                                                     
117500D        CALL "J3KSHOW" USING DATA-BUFFER I                               
117600         ADD I2 TO RECV-LOC                                               
117700         SUBTRACT I2 FROM RECV-LEN                                        
117800     END-PERFORM.                                                         
117900                                                                          
118000*-----Ignore any excess data (ACTL-LEN > MAX-LEN)-----*                   
118100                                                                          
118200     IF ACTL-LEN GREATER THAN MAX-LEN                                     
118300         COMPUTE RECV-LEN = ACTL-LEN - MAX-LEN                            
118400D        MOVE RECV-LEN TO DISP-SN4                                        
118500D        DISPLAY THIS-PROG "Ignoring" DISP-SN4 " bytes"                   
118600         PERFORM UNTIL RECV-LEN LESS THAN 1                               
118700D            MOVE RECV-LEN TO DISP-SN4                                    
118800D            DISPLAY THIS-PROG "Receiving" DISP-SN4 " bytes"              
118900             IF RECV-LEN GREATER THAN 80                                  
119000                 MOVE 80 TO I2                                            
119100             ELSE                                                         
119200                 MOVE RECV-LEN TO I2                                      
119300             END-IF                                                       
119400             CALL INTRINSIC "IPCRECV" USING SOCKET-ID                     
119500                 WORK-X I2 \\ \\ LONG-ERROR                               
119600             IF LONG-ERROR NOT = ZERO AND 59                              
119700                 MOVE "IPCRECV" TO ERROR-CALL                             
119800                 MOVE SOCKET-ID TO ERROR-SOCKET-ID                        
119900                 PERFORM 9010-IPC-CALL-ERROR                              
120000                 GO TO 1900-RETURN                                        
120100             END-IF                                                       
120200             IF N-ERR = 59                                                
120300                MOVE 0 TO N-ERR I2                                        
120400             END-IF                                                       
120500D            MOVE I2 TO DISP-SN4                                          
120600D            DISPLAY THIS-PROG "Received" DISP-SN4 " bytes"               
120700D            MOVE 1 TO I                                                  
120800D            MOVE I2 TO L                                                 
120900D            PERFORM UNTIL L < 1                                          
121000D                IF L > 60                                                
121100D                    MOVE 60 TO N                                         
121200D                ELSE                                                     
121300D                    MOVE L TO N                                          
121400D                END-IF                                                   
121500D                DISPLAY THIS-PROG "[" WORK-X(I:N) "]"                    
121600D                ADD N TO I                                               
121700D                SUBTRACT N FROM L                                        
121800D            END-PERFORM                                                  
121900             SUBTRACT I2 FROM RECV-LEN                                    
122000         END-PERFORM                                                      
122100     END-IF.                                                              
122200                                                                          
122300*--------- SEND ACK TO THE REMOTE PROCESS -------------                   
122400     MOVE "Y" TO ACKBUF.                                                  
122500     CALL "J3KWRITACK" USING SOCKET-ID ACKBUF N-ERR.                      
122600                                                                          
122700*-----Return to caller-----*                                              
122800                                                                          
122900 1900-RETURN.                                                             
123000D    DISPLAY THIS-PROG "1900-RETURN".                                     
123100     GOBACK.                                                              
123200                                                                          
123300*-----IPC call error-----*                                                
123400                                                                          
123500 9010-IPC-CALL-ERROR.                                                     
123600D    DISPLAY THIS-PROG "9010-IPC-CALL-ERROR".                             
123700     MOVE LONG-ERROR TO N-ERR.                                            
123800     MOVE LONG-ERROR TO DISP-SN4.                                         
123900     MOVE ERROR-SOCKET-ID TO DISP-SN5.                                    
124000D    DISPLAY THIS-PROG "Error" DISP-SN4 " occurred calling "              
124100D        ERROR-CALL " - DISCRIPTOR" DISP-SN5.                             
124200     MOVE LONG-ERROR TO I2.                                               
124300     MOVE SPACES TO ERROR-MSG.                                            
124400     MOVE I2 TO N-ERR.                                                    
124500     INITIALIZE ERROR-MSG I.                                              
124600     IF N-ERR NOT = 59                                                    
124700        CALL "J3KSOCKERR" USING N-ERR ERROR-MSG I                         
124800     ELSE                                                                 
124900        CALL "J3KSOCKERR" USING N-ERR ERROR-MSG I                         
125000        MOVE 11 TO N-ERR                                                  
125100        INITIALIZE ERROR-MSG I                                            
125200        CALL "J3KSOCKERR" USING N-ERR ERROR-MSG I.                        
125300     MOVE I TO N2.                                                        
125400D    IF LONG-ERROR = ZERO                                                 
125500D        DISPLAY THIS-PROG "----------IPC ERROR MESSAGE----------"        
125600D        DISPLAY ERROR-MSG(1:N2).                                         
125700                                                                          
125800 END PROGRAM J3KREADSOCK.                                                 
125900$PAGE "J3KCLOSESOCK - Disconnect from remote process"                     
127000$CONTROL SYNC32,RLFILE,LIST,DYNAMIC,OPTFEATURES=LINKALIGNED16             
127100 IDENTIFICATION DIVISION.                                                 
127200 PROGRAM-ID. J3KCLOSESOCK.                                                
127300 AUTHOR.     Michael Anderson.                                            
127400 DATE-COMPILED.                                                           
128400 ENVIRONMENT DIVISION.                                                    
128600 CONFIGURATION SECTION.                                                   
128700 SOURCE-COMPUTER. HP3000.                                                 
128800* SOURCE-COMPUTER. HP3000 WITH DEBUGGING MODE.                            
128900 OBJECT-COMPUTER. HP3000.                                                 
129000 SPECIAL-NAMES.                                                           
129100     CONDITION-CODE IS CC.                                                
129400 DATA DIVISION.                                                           
129800 WORKING-STORAGE SECTION.                                                 
130100 01  I                     PIC S9(4) COMP.                                
130200 01  I2                    PIC S9(9) COMP.                                
130300 01  L                     PIC S9(4) COMP.                                
130400 01  N                     PIC S9(4) COMP.                                
130500 01  N2                    PIC S9(9) COMP.                                
130600                                                                          
130700 01  THIS-PROG             PIC X(13) VALUE "J3KCLOSESOCK ".               
130800                                                                          
130900 01  ACKTIMEOUT            PIC S9(4) COMP.                                
131000 01  ACKBUF                PIC X VALUE SPACES.                            
131100     88 GOOD-ACK           VALUE "Y".                                     
131200     88 BAD-ACK            VALUE "N".                                     
131300                                                                          
131400 01  WORK-NX.                                                             
131500     02  WORK-N            PIC S9(4) COMP.                                
131600                                                                          
131700 01  ERROR-CALL            PIC X(10).                                     
131800 01  ERROR-SOCKET-ID      PIC S9(9) COMP.                                 
131900 01  ERROR-MSG             PIC X(80).                                     
132000                                                                          
132100 01  LONG-ERROR            PIC S9(9) COMP VALUE ZERO.                     
132200 01  FILLER REDEFINES LONG-ERROR.                                         
132300     02  FILLER            PIC XX.                                        
132400     02  SHORT-ERROR       PIC S9(4) COMP.                                
132500                                                                          
132600 01  DISP-N2               PIC 99.                                        
132700 01  DISP-N3               PIC 999.                                       
132800 01  DISP-SN4              PIC ----9.                                     
132900 01  DISP-SN5              PIC -----9.                                    
133200 LINKAGE SECTION.                                                         
133500 01  SOCKET-ID            PIC S9(9) COMP SYNC.                            
133700 01  N-ERR                 PIC S9(4) COMP.                                
134000 PROCEDURE DIVISION USING SOCKET-ID N-ERR.                                
134200                                                                          
134300 1000-BEGIN.                                                              
134400D    DISPLAY THIS-PROG "1000-BEGIN".                                      
134500     MOVE ZERO TO N-ERR.                                                  
134600                                                                          
134700*-----Send the close record-----*                                         
134800                                                                          
134900D    DISPLAY THIS-PROG "Sending close record".                            
135000     MOVE -9999 TO WORK-N.                                                
135100     MOVE 2 TO I2.                                                        
135200     CALL INTRINSIC "IPCSEND" USING                                       
135300         SOCKET-ID WORK-NX I2 \\ \\ LONG-ERROR.                           
135400     IF LONG-ERROR NOT = ZERO                                             
135500         MOVE "IPCSEND" TO ERROR-CALL                                     
135600         MOVE SOCKET-ID TO ERROR-SOCKET-ID                                
135700         PERFORM 9010-IPC-CALL-ERROR                                      
135800         GO TO 1900-RETURN.                                               
135900                                                                          
136000*------ WAIT FOR ACK BACK FROM REMOTE.                                    
136100     MOVE 60  TO ACKTIMEOUT.                                              
136200     CALL "J3KREADACK" USING SOCKET-ID ACKTIMEOUT ACKBUF N-ERR.           
136300                                                                          
136400*-----Wait for sign that all data has made it to remote-----*             
136500                                                                          
136600*    Set timeout to 10 seconds                                            
136700                                                                          
136800D    DISPLAY THIS-PROG "Set timeout to 10 seconds".                       
136900     MOVE 100 TO WORK-N.                                                  
137000     CALL INTRINSIC "IPCCONTROL" USING                                    
137100         SOCKET-ID \3\ WORK-NX \2\ \\ \\ \\ LONG-ERROR.                   
137200     IF LONG-ERROR NOT = ZERO                                             
137300         MOVE "IPCCONTROL" TO ERROR-CALL                                  
137400         MOVE SOCKET-ID TO ERROR-SOCKET-ID                                
137500         PERFORM 9010-IPC-CALL-ERROR                                      
137600         GO TO 1900-RETURN.                                               
137700                                                                          
137800*    Do token IPCRECV                                                     
137900                                                                          
138000D    DISPLAY THIS-PROG "Do a token IPCRECV".                              
138100     MOVE 1 TO I2.                                                        
138200     CALL INTRINSIC "IPCRECV" USING                                       
138300         SOCKET-ID WORK-NX I2 \\ \\ LONG-ERROR.                           
138800D    DISPLAY THIS-PROG "Shutdown virtual connection".                     
138900     CALL INTRINSIC "IPCSHUTDOWN" USING                                   
139000         SOCKET-ID \\ \\ LONG-ERROR.                                      
139100     IF LONG-ERROR NOT = ZERO                                             
139200         MOVE "IPCSHUTDOWN" TO ERROR-CALL                                 
139300         MOVE SOCKET-ID TO ERROR-SOCKET-ID                                
139400         PERFORM 9010-IPC-CALL-ERROR.                                     
139500     MOVE ZERO TO SOCKET-ID.                                              
139900 1900-RETURN.                                                             
140000D    DISPLAY THIS-PROG " 1900-RETURN".                                    
140100     GOBACK.                                                              
140500 9010-IPC-CALL-ERROR.                                                     
140600D    DISPLAY THIS-PROG "9010-IPC-CALL-ERROR".                             
140700     MOVE LONG-ERROR TO N-ERR.                                            
140800     MOVE LONG-ERROR TO DISP-SN4.                                         
140900     MOVE ERROR-SOCKET-ID TO DISP-SN5.                                    
141000D    DISPLAY THIS-PROG " Error" DISP-SN4 " occurred calling "             
141100D        ERROR-CALL " - DISCRIPTOR" DISP-SN5.                             
141200     MOVE LONG-ERROR TO I2.                                               
141300     MOVE SPACES TO ERROR-MSG.                                            
141400     MOVE I2 TO N-ERR.                                                    
141500     INITIALIZE ERROR-MSG I.                                              
141600D    CALL "J3KSOCKERR" USING N-ERR ERROR-MSG I.                           
141700     MOVE I TO N2.                                                        
141800D    IF LONG-ERROR = ZERO                                                 
141900D        DISPLAY THIS-PROG "----------IPC ERROR MESSAGE----------"        
142000D        DISPLAY ERROR-MSG(1:N2).                                         
142100                                                                          
142200 END PROGRAM J3KCLOSESOCK.                                                
142300$PAGE "J3KWRITACK - Send ACK= Y to a remote process"                      
143400$CONTROL SYNC32,RLFILE,LIST,DYNAMIC,OPTFEATURES=LINKALIGNED16             
143500 IDENTIFICATION DIVISION.                                                 
143600 PROGRAM-ID. J3KWRITACK.                                                  
143700 AUTHOR.     MICHAEL ANDERSON.                                            
143800 DATE-COMPILED.                                                           
144800 ENVIRONMENT DIVISION.                                                    
145000 CONFIGURATION SECTION.                                                   
145100 SOURCE-COMPUTER. HP3000.                                                 
145200* SOURCE-COMPUTER. HP3000 WITH DEBUGGING MODE.                            
145300 OBJECT-COMPUTER. HP3000.                                                 
145400 SPECIAL-NAMES.                                                           
145500     CONDITION-CODE IS CC.                                                
145800 DATA DIVISION.                                                           
146200 WORKING-STORAGE SECTION.                                                 
146500 01  I                     PIC S9(4) COMP.                                
146600 01  I2                    PIC S9(9) COMP.                                
146700 01  L                     PIC S9(4) COMP.                                
146800 01  N                     PIC S9(4) COMP.                                
146900 01  N2                    PIC S9(9) COMP.                                
147000                                                                          
147100 01  THIS-PROG             PIC X(11) VALUE "J3KWRITACK ".                 
147200                                                                          
147300 01  ACTL-LEN              PIC 9(4) COMP.                                 
147400                                                                          
147500 01  WORK-NX.                                                             
147600     02  WORK-N            PIC S9(4) COMP.                                
147700                                                                          
147800 01  ERROR-CALL            PIC X(10).                                     
147900 01  ERROR-SOCKET-ID      PIC S9(9) COMP.                                 
148000 01  ERROR-MSG             PIC X(80).                                     
148100                                                                          
148200 01  LONG-ERROR            PIC S9(9) COMP VALUE ZERO.                     
148300 01  FILLER REDEFINES LONG-ERROR.                                         
148400     02  FILLER            PIC XX.                                        
148500     02  SHORT-ERROR       PIC S9(4) COMP.                                
148600                                                                          
148700 01  DISP-N2               PIC 99.                                        
148800 01  DISP-N3               PIC 999.                                       
148900 01  DISP-SN4              PIC ----9.                                     
149000 01  DISP-SN5              PIC -----9.                                    
149100 01  DISP-SN9              PIC ---------9.                                
149200 01  DATA-LEN              PIC S9(4) COMP VALUE 1.                        
149300                                                                          
149400*==================================*                                      
149500 LINKAGE SECTION.                                                         
149600*==================================*                                      
149700                                                                          
149800 01  SOCKET-ID            PIC S9(9) COMP SYNC.                            
149900 01  DATA-BUFFER           PIC X.                                         
150000 01  N-ERR                 PIC S9(4) COMP.                                
150100                                                                          
150200******************************************************************        
150300 PROCEDURE DIVISION USING SOCKET-ID DATA-BUFFER N-ERR.                    
150400******************************************************************        
150500                                                                          
150600 1000-BEGIN.                                                              
150700D    DISPLAY THIS-PROG "1000-BEGIN".                                      
150800D    MOVE SOCKET-ID TO DISP-SN9.                                          
150900D    DISPLAY THIS-PROG "SOCKET-ID: " DISP-SN9.                            
151000     MOVE ZERO TO N-ERR.                                                  
151100*-----Send the data-----*                                                 
151200                                                                          
151300     MOVE DATA-LEN TO I2 DISP-SN5.                                        
151400D    DISPLAY THIS-PROG " SENDING " DISP-SN5 " OF DATA".                   
151500     CALL INTRINSIC "IPCSEND" USING                                       
151600         SOCKET-ID DATA-BUFFER I2 \\ \\ LONG-ERROR.                       
151700     IF LONG-ERROR NOT = ZERO                                             
151800         MOVE "IPCSEND" TO ERROR-CALL                                     
151900         MOVE SOCKET-ID TO ERROR-SOCKET-ID                                
152000         PERFORM 9010-IPC-CALL-ERROR.                                     
152100                                                                          
152200*-----Return to caller-----*                                              
152300                                                                          
152400 1900-RETURN.                                                             
152500D    DISPLAY THIS-PROG " 1900-RETURN".                                    
152600     GOBACK.                                                              
152700                                                                          
152800*-----IPC call error-----*                                                
152900                                                                          
153000 9010-IPC-CALL-ERROR.                                                     
153100D    DISPLAY THIS-PROG "9010-IPC-CALL-ERROR".                             
153200     MOVE LONG-ERROR TO N-ERR.                                            
153300     MOVE LONG-ERROR TO DISP-SN4.                                         
153400     MOVE ERROR-SOCKET-ID TO DISP-SN5.                                    
153500D    DISPLAY THIS-PROG " Error" DISP-SN4 " occurred calling "             
153600D        ERROR-CALL " - DISCRIPTOR" DISP-SN5.                             
153700     MOVE LONG-ERROR TO I2.                                               
153800     MOVE SPACES TO ERROR-MSG.                                            
153900     MOVE I2 TO N-ERR.                                                    
154000     INITIALIZE ERROR-MSG I.                                              
154100     CALL "J3KSOCKERR" USING N-ERR ERROR-MSG I.                           
154200     MOVE I TO N2.                                                        
154300D    IF LONG-ERROR = ZERO                                                 
154400D        DISPLAY THIS-PROG "----------IPC ERROR MESSAGE----------"        
154500D        DISPLAY ERROR-MSG(1:N2).                                         
154600                                                                          
154700 END PROGRAM J3KWRITACK.                                                  
154800$PAGE "J3KREADACK - Receive ACK from a remote process"                    
155900$CONTROL SYNC32,RLFILE,LIST,DYNAMIC,OPTFEATURES=LINKALIGNED16             
156000 IDENTIFICATION DIVISION.                                                 
156100 PROGRAM-ID. J3KREADACK.                                                  
156200 AUTHOR.     MICHAEL ANDERSON.                                            
156300 DATE-COMPILED.                                                           
157300 ENVIRONMENT DIVISION.                                                    
157500 CONFIGURATION SECTION.                                                   
157600 SOURCE-COMPUTER. HP3000.                                                 
157700* SOURCE-COMPUTER. HP3000 WITH DEBUGGING MODE.                            
157800 OBJECT-COMPUTER. HP3000.                                                 
157900 SPECIAL-NAMES.                                                           
158000     CONDITION-CODE IS CC.                                                
158300 DATA DIVISION.                                                           
158700 WORKING-STORAGE SECTION.                                                 
159000 01  I                     PIC S9(4) COMP.                                
159100 01  I2                    PIC S9(9) COMP.                                
159200 01  L                     PIC S9(4) COMP.                                
159300 01  N                     PIC S9(4) COMP.                                
159400 01  N2                    PIC S9(9) COMP.                                
159500                                                                          
159600 01  THIS-PROG             PIC X(11) VALUE "J3KREADACK ".                 
159700                                                                          
159800 01  RECV-LEN              PIC 9(4) COMP.                                 
159900 01  RECV-LOC              PIC S9(4) COMP.                                
160000                                                                          
160100 01  ACTL-LEN              PIC 9(4) COMP.                                 
160200 01  MAX-LEN               PIC 9(4) COMP.                                 
160300                                                                          
160400 01  LEN-X.                                                               
160500     02  LEN-N             PIC S9(4) COMP.                                
160600                                                                          
160700 01  WORK-NX.                                                             
160800     02  WORK-N            PIC S9(4) COMP.                                
160900                                                                          
161000 01  WORK-X                PIC X(80).                                     
161100                                                                          
161200 01  ERROR-CALL            PIC X(10).                                     
161300 01  ERROR-SOCKET-ID      PIC S9(9) COMP.                                 
161400 01  ERROR-MSG             PIC X(80).                                     
161500                                                                          
161600 01  LONG-ERROR            PIC S9(9) COMP VALUE ZERO.                     
161700 01  FILLER REDEFINES LONG-ERROR.                                         
161800     02  FILLER            PIC XX.                                        
161900     02  SHORT-ERROR       PIC S9(4) COMP.                                
162000                                                                          
162100 01  DISP-N2               PIC 99.                                        
162200 01  DISP-N3               PIC 999.                                       
162300 01  DISP-SN4              PIC ----9.                                     
162400 01  DISP-SN5              PIC -----9.                                    
162500 01  DISP-SN9              PIC ---------9.                                
162600 01  DATA-LEN              PIC S9(4) COMP VALUE 1.                        
162700                                                                          
162800*==================================*                                      
162900 LINKAGE SECTION.                                                         
163000*==================================*                                      
163100                                                                          
163200 01  SOCKET-ID            PIC S9(9) COMP SYNC.                            
163300 01  TIMEOUT-VALUE         PIC S9(4) COMP.                                
163400 01  DATA-BUFFER           PIC X.                                         
163500 01  N-ERR                 PIC S9(4) COMP.                                
163600                                                                          
163700******************************************************************        
163800 PROCEDURE DIVISION USING SOCKET-ID TIMEOUT-VALUE DATA-BUFFER             
163900                          N-ERR.                                          
164000******************************************************************        
164100                                                                          
164200 1000-BEGIN.                                                              
164300D    DISPLAY THIS-PROG "1000-BEGIN".                                      
164400D    MOVE SOCKET-ID TO DISP-SN9.                                          
164500D    DISPLAY THIS-PROG "SOCKET-ID: " DISP-SN9.                            
164600     INITIALIZE N-ERR DATA-BUFFER.                                        
164700     MOVE TIMEOUT-VALUE TO DISP-N3.                                       
164800*    Set timeout to TIMEOUT-VALUE seconds                                 
164900                                                                          
165000D    DISPLAY THIS-PROG "Set timeout to " DISP-N3   " seconds".            
165100     COMPUTE WORK-N = TIMEOUT-VALUE * 10.                                 
165200     CALL INTRINSIC "IPCCONTROL" USING                                    
165300         SOCKET-ID \3\ WORK-NX \2\ \\ \\ \\ LONG-ERROR.                   
165400     IF LONG-ERROR NOT = ZERO                                             
165500         MOVE "IPCCONTROL" TO ERROR-CALL                                  
165600         MOVE SOCKET-ID TO ERROR-SOCKET-ID                                
165700         PERFORM 9010-IPC-CALL-ERROR                                      
165800         GO TO 1900-RETURN.                                               
165900                                                                          
166000*    Receive the data                                                     
166100                                                                          
166200D    DISPLAY THIS-PROG "Receive the data".                                
166300     MOVE 1 TO I2.                                                        
166400     CALL INTRINSIC "IPCRECV" USING SOCKET-ID                             
166500          DATA-BUFFER I2 \\ \\ LONG-ERROR                                 
166600     IF LONG-ERROR NOT = ZERO                                             
166700         MOVE "IPCRECV" TO ERROR-CALL                                     
166800         MOVE SOCKET-ID TO ERROR-SOCKET-ID                                
166900         PERFORM 9010-IPC-CALL-ERROR                                      
167000         GO TO 1900-RETURN.                                               
167100                                                                          
167200     MOVE I2 TO DISP-SN4.                                                 
167300D    DISPLAY THIS-PROG "Received" DISP-SN4 " bytes".                      
167400*-----Return to caller-----*                                              
167500                                                                          
167600 1900-RETURN.                                                             
167700D    DISPLAY THIS-PROG "1900-RETURN".                                     
167800     GOBACK.                                                              
167900                                                                          
168000*-----IPC call error-----*                                                
168100                                                                          
168200 9010-IPC-CALL-ERROR.                                                     
168300D    DISPLAY THIS-PROG "9010-IPC-CALL-ERROR".                             
168400     MOVE LONG-ERROR TO N-ERR.                                            
168500     MOVE LONG-ERROR TO DISP-SN4.                                         
168600     MOVE ERROR-SOCKET-ID TO DISP-SN5.                                    
168700D    DISPLAY THIS-PROG "Error" DISP-SN4 " occurred calling "              
168800D        ERROR-CALL " - DISCRIPTOR" DISP-SN5.                             
168900     MOVE LONG-ERROR TO I2.                                               
169000     MOVE SPACES TO ERROR-MSG.                                            
169100     MOVE I2 TO N-ERR.                                                    
169200     INITIALIZE ERROR-MSG I.                                              
169300     IF N-ERR NOT = 59                                                    
169400        CALL "J3KSOCKERR" USING N-ERR ERROR-MSG I                         
169500     ELSE                                                                 
169600        CALL "J3KSOCKERR" USING N-ERR ERROR-MSG I                         
169700        MOVE -11 TO N-ERR                                                 
169800        INITIALIZE ERROR-MSG I                                            
169900        CALL "J3KSOCKERR" USING N-ERR ERROR-MSG I.                        
170000                                                                          
170100     MOVE I TO N2.                                                        
170200D    IF LONG-ERROR = ZERO                                                 
170300D        DISPLAY THIS-PROG "----------IPC ERROR MESSAGE----------"        
170400D        DISPLAY ERROR-MSG(1:N2).                                         
170500                                                                          
170600 END PROGRAM J3KREADACK.                                                  
170700$PAGE "J3KSOCKERR - Pass error number, receive message"                   
171800$CONTROL SYNC32,RLFILE,LIST,DYNAMIC,OPTFEATURES=LINKALIGNED16             
171900 IDENTIFICATION DIVISION.                                                 
172000 PROGRAM-ID. J3KSOCKERR.                                                  
172100 AUTHOR.     MICHAEL ANDERSON.                                            
172200 DATE-COMPILED.                                                           
173200 ENVIRONMENT DIVISION.                                                    
173400 CONFIGURATION SECTION.                                                   
173500 SOURCE-COMPUTER. HP3000.                                                 
173600* SOURCE-COMPUTER. HP3000 WITH DEBUGGING MODE.                            
173700 OBJECT-COMPUTER. HP3000.                                                 
173800 SPECIAL-NAMES.                                                           
173900     CONDITION-CODE IS CC.                                                
174000 INPUT-OUTPUT SECTION.                                                    
174100 FILE-CONTROL.                                                            
174200     SELECT NWCAT ASSIGN "NWCAT.PUB.J3K"                                  
174300                         ORGANIZATION IS SEQUENTIAL                       
174400                         ACCESS IS SEQUENTIAL                             
174500                         FILE STATUS IS NWCAT-STATUS.                     
174600 DATA DIVISION.                                                           
174700 FILE SECTION.                                                            
174800 FD NWCAT.                                                                
174900 01 NWCAT-RECORD           PIC X(80).                                     
175000 WORKING-STORAGE SECTION.                                                 
175100*============================================*                            
175200 01  NWCAT-STATUS          PIC XX VALUE "00".                             
175300 01  I                     PIC S9(4) COMP VALUE 0.                        
175400 01  I2                    PIC S9(9) COMP VALUE 0.                        
175500 01  N2                    PIC S9(9) COMP.                                
175600 01 COMMAND-STRING         PIC X(48) VALUE SPACES.                        
175700 01 MSGTEXT-ADDRESS        PIC S9(4) COMP VALUE 0.                        
175800 01 MSGLEN                 PIC S9(4) COMP VALUE 0.                        
175900 01 CONLEN                 PIC S9(4) COMP VALUE 0.                        
176000 01 RECTYPE-SW             PIC X VALUE "0".                               
176100    88 MSG-RECORD          VALUE "3".                                     
176200    88 COMMENT-RECORD      VALUE "1", "0".                                
176300    88 COMMAND-RECORD      VALUE "2".                                     
176400 01 COMMAND-SWITCHES              VALUE "000".                            
176500    02 CONSOLE-SW          PIC X.                                         
176600       88 CONSOLE-ON          VALUE "1".                                  
176700       88 CONSOLE-OFF         VALUE "0".                                  
176800    02 STDLIST-SW          PIC X.                                         
176900       88 STDLIST-ON          VALUE "1".                                  
177000       88 STDLIST-OFF         VALUE "0".                                  
177100    02 LOGFILE-SW          PIC X.                                         
177200       88 LOGFILE-ON          VALUE "1".                                  
177300       88 LOGFILE-OFF         VALUE "0".                                  
177500 01  THIS-PROG             PIC X(11) VALUE "J3KSOCKERR ".                 
177700 01  LFNAME                 PIC X(36)  VALUE SPACES.                      
177800 01  LFNUM                  PIC S9(4)  COMP VALUE 0.                      
177900 01  LFBUFLEN               PIC S9(4)  COMP VALUE 0.                      
178000 01  LFBUF                  PIC X(160) VALUE SPACES.                      
178100 01  THIS-PROGRAM           PIC X(36)  VALUE SPACES.                      
178200 01  THIS-DATE              PIC X(8)   VALUE SPACES.                      
178300 01  THIS-TIME              PIC X(8)   VALUE SPACES.                      
178400 01  ERROR-MSG             PIC X(80).                                     
178600 01  LONG-ERROR            PIC S9(9) COMP VALUE ZERO.                     
178700 01  FILLER REDEFINES LONG-ERROR.                                         
178800     02  FILLER            PIC XX.                                        
178900     02  SHORT-ERROR       PIC S9(4) COMP.                                
179000 01  DISP-SN5              PIC -----9.                                    
179200 01  NUM1                  PIC X(14) VALUE SPACES.                        
179300 01  NUM2                  PIC S9(14) VALUE 0.                            
179400 01  NUMDEC                PIC S9(4) COMP VALUE 0.                        
179500 01  NUMERR                PIC S9(4) COMP VALUE 0.                        
179600                                                                          
179700 LINKAGE SECTION.                                                         
179800                                                                          
179900 01  LINK-ERROR            PIC S9(4) COMP.                                
180000 01  LINK-MESSAGE          PIC X(80).                                     
180100 01  LINK-LEN              PIC S9(4) COMP.                                
180400******************************************************************        
180500 PROCEDURE DIVISION USING LINK-ERROR LINK-MESSAGE LINK-LEN.               
180600******************************************************************        
180800 0001-START.                                                              
180900                                                                          
181000     OPEN INPUT NWCAT.                                                    
181100     IF NWCAT-STATUS NOT = "00"                                           
181200        MOVE SPACES TO LINK-MESSAGE                                       
181300        STRING  "Open NWCAT failed! status =[" NWCAT-STATUS "]"           
181400         DELIMITED BY SIZE INTO LINK-MESSAGE                              
181500        GO TO ABEND-OF-PROGRAM.                                           
181600                                                                          
181700     PERFORM UNTIL NWCAT-STATUS = "90"                                    
181800      READ NWCAT AT END                                                   
181900                  MOVE "90" TO NWCAT-STATUS                               
182000                  MOVE LINK-ERROR TO DISP-SN5                             
182100                  MOVE DISP-SN5 TO LINK-MESSAGE                           
182200                  MOVE "Unknown Error!" TO LINK-MESSAGE(9:)               
182300         END-READ                                                         
182400      IF NWCAT-STATUS NOT = "90"                                          
182500         PERFORM 2000-GET-RECTYPE                                         
182600         IF ( MSG-RECORD )  AND ( NUM2 = LINK-ERROR )                     
182700            PERFORM 2001-GET-MSGTEXT                                      
182800            MOVE "90" TO NWCAT-STATUS                                     
182900         END-IF                                                           
183000         IF COMMAND-RECORD                                                
183100            PERFORM 2002-COMMAND                                          
183200         END-IF                                                           
183300      END-IF                                                              
183400     END-PERFORM.                                                         
183500     GO TO END-OF-PROGRAM.                                                
183600*---------------------------------------------------------------          
183700 2000-GET-RECTYPE.                                                        
183800     INITIALIZE NUM1 NUM2 NUMDEC NUMERR.                                  
183900     MOVE "0" TO RECTYPE-SW.                                              
184000     IF NWCAT-RECORD(1:2) = "$ "                                          
184100        MOVE "1" TO RECTYPE-SW                                            
184200     ELSE IF NWCAT-RECORD(1:1) = "$"                                      
184300             MOVE "2" TO RECTYPE-SW                                       
184400          ELSE                                                            
184500             PERFORM VARYING I2 FROM 1 BY 1                               
184600               UNTIL ( I2 > 10 )                                          
184700                  OR ( NWCAT-RECORD(I2:1) = SPACE )                       
184800               MOVE NWCAT-RECORD(I2:1) TO NUM1(I2:1)                      
184900             END-PERFORM                                                  
185000             CALL "NUMGET" USING NUM1 NUM2 NUMDEC NUMERR                  
185100             IF ( NUMERR = 0 ) AND ( NUMDEC = 0 )                         
185200                MOVE "3" TO RECTYPE-SW                                    
185300                MOVE I2 TO MSGTEXT-ADDRESS.                               
185400*---------------------------------------------------------------          
185500 2001-GET-MSGTEXT.                                                        
185600     PERFORM VARYING I2 FROM MSGTEXT-ADDRESS BY 1                         
185700       UNTIL ( I2 > 80 )                                                  
185800          OR ( NWCAT-RECORD(I2:1) = "&" )                                 
185900      CONTINUE                                                            
186000     END-PERFORM.                                                         
186100     IF I2 > 80                                                           
186200        COMPUTE MSGLEN = ( 80 - MSGTEXT-ADDRESS )                         
186300        MOVE NWCAT-RECORD(MSGTEXT-ADDRESS:MSGLEN)                         
186400          TO LINK-MESSAGE                                                 
186500     ELSE                                                                 
186600        COMPUTE MSGLEN = ( I2 - MSGTEXT-ADDRESS )                         
186700        MOVE NWCAT-RECORD(MSGTEXT-ADDRESS:MSGLEN)                         
186800          TO LINK-MESSAGE                                                 
186900        READ NWCAT AT END MOVE "90" TO NWCAT-STATUS END-READ              
187000        IF NWCAT-STATUS NOT = "90"                                        
187100           COMPUTE CONLEN = ( 80 - I2 )                                   
187200           MOVE NWCAT-RECORD(1:CONLEN) TO LINK-MESSAGE(I2:).              
187300*---------------------------------------------------------------          
187400 2002-COMMAND.                                                            
187500                                                                          
187600     PERFORM VARYING I2 FROM 2 BY 1                                       
187700       UNTIL ( I2 > 15 )                                                  
187800          OR ( NWCAT-RECORD(I2:1) = SPACE )                               
187900      CONTINUE                                                            
188000     END-PERFORM.                                                         
188100     MOVE NWCAT-RECORD(2:I2) TO COMMAND-STRING.                           
188200     IF COMMAND-STRING = "ON_STDLIST"                                     
188300        MOVE "1" TO STDLIST-SW                                            
188400     ELSE IF COMMAND-STRING = "ON_CONSOLE"                                
188500             MOVE "1" TO CONSOLE-SW                                       
188600          ELSE IF COMMAND-STRING = "ON_LOGFILE"                           
188700                  MOVE "1" TO LOGFILE-SW.                                 
188800*---------------------------------------------------------------          
188900 2003-LOGFILE-MESSAGE.                                                    
189000D    DISPLAY "2003-LOGFILE-MESSAGE".                                      
189100     INITIALIZE LFBUF LFNUM THIS-PROGRAM THIS-DATE THIS-TIME.             
189200     MOVE "NWLOG.PUB.J3K~" TO LFNAME.                                     
189300     CALL "PROCNAME" USING THIS-PROGRAM.                                  
189400     CALL "GETCURRENT" USING THIS-DATE I2 I.                              
189500     ACCEPT THIS-TIME FROM TIME.                                          
189600     STRING THIS-DATE ":" THIS-TIME ":" THIS-PROGRAM ":"                  
189700      DELIMITED BY SIZE INTO LFBUF.                                       
189800     MOVE LINK-MESSAGE(1:LINK-LEN) TO LFBUF(58:LINK-LEN).                 
189900     COMPUTE LFBUFLEN = LFBUFLEN - ( LINK-LEN + 58 ).                     
190000     CALL INTRINSIC "FOPEN"                                               
190100          USING LFNAME \%20007\ \%2303\ GIVING LFNUM.                     
190200     IF CC <> ZERO                                                        
190300        DISPLAY "OPENING " LFNAME                                         
190400        CALL INTRINSIC "PRINTFILEINFO" USING LFNUM                        
190500     ELSE                                                                 
190600        CALL INTRINSIC "FWRITE" USING LFNUM LFBUF LFBUFLEN \0\.           
190700     IF CC <> ZERO                                                        
190800        DISPLAY "WRITTING " LFNAME                                        
190900        CALL INTRINSIC "PRINTFILEINFO" USING LFNUM.                       
191000     CALL INTRINSIC "FCLOSE" USING LFNUM \0\ \0\.                         
191100                                                                          
191200*---------------------------------------------------------------          
191300 ABEND-OF-PROGRAM.                                                        
191400     MOVE "1" TO CONSOLE-SW.                                              
191500     MOVE "1" TO STDLIST-SW.                                              
191600     STRING "J3KSOCKERR, abnormal end. " LINK-MESSAGE                     
191700      DELIMITED BY SIZE INTO ERROR-MSG.                                   
191800     MOVE ERROR-MSG     TO LINK-MESSAGE.                                  
191900*---------------------------------------------------------------          
192000 END-OF-PROGRAM.                                                          
192100     IF LINK-MESSAGE = SPACES                                             
192200        MOVE 0 TO LINK-LEN                                                
192300     ELSE                                                                 
192400        PERFORM VARYING LINK-LEN FROM 80 BY -1                            
192500          UNTIL ( LINK-MESSAGE(LINK-LEN:1) NOT = SPACE )                  
192600             OR ( LINK-LEN < 1 )                                          
192700         CONTINUE                                                         
192800        END-PERFORM.                                                      
192900     IF STDLIST-ON                                                        
193000        DISPLAY LINK-MESSAGE(1:LINK-LEN).                                 
193100     IF CONSOLE-ON                                                        
193200        DISPLAY LINK-MESSAGE(1:LINK-LEN) UPON CONSOLE.                    
193300     IF LOGFILE-ON PERFORM 2003-LOGFILE-MESSAGE.                          
193400     CLOSE NWCAT.                                                         
193500     GOBACK.                                                              
193600 END PROGRAM J3KSOCKERR.                                                  
193700$PAGE "J3KREADSOCKTO  - Receive data from a remote process"               
194800$CONTROL SYNC32,RLFILE,LIST,DYNAMIC,OPTFEATURES=LINKALIGNED16             
194900 IDENTIFICATION DIVISION.                                                 
195000 PROGRAM-ID. J3KREADSOCKTO.                                               
195100 AUTHOR.     Michael Anderson.                                            
195200 DATE-COMPILED.                                                           
196400 ENVIRONMENT DIVISION.                                                    
196600 CONFIGURATION SECTION.                                                   
196700 SOURCE-COMPUTER. HP3000.                                                 
196800* SOURCE-COMPUTER. HP3000 WITH DEBUGGING MODE.                            
196900 OBJECT-COMPUTER. HP3000.                                                 
197000 SPECIAL-NAMES.                                                           
197100     CONDITION-CODE IS CC.                                                
197400 DATA DIVISION.                                                           
197800 WORKING-STORAGE SECTION.                                                 
198100 01  I                     PIC S9(4) COMP.                                
198200 01  I2                    PIC S9(9) COMP.                                
198300 01  L                     PIC S9(4) COMP.                                
198400 01  N                     PIC S9(4) COMP.                                
198500 01  N2                    PIC S9(9) COMP.                                
198600                                                                          
198700 01  THIS-PROG             PIC X(14) VALUE "J3KREADSOCKTO ".              
198800                                                                          
198900 01  ACKTIMEOUT            PIC S9(4) COMP.                                
199000 01  ACKBUF                PIC X VALUE SPACES.                            
199100     88 GOOD-ACK           VALUE "Y".                                     
199200     88 BAD-ACK            VALUE "N".                                     
199300                                                                          
199400 01  RECV-LEN              PIC 9(4) COMP.                                 
199500 01  RECV-LOC              PIC S9(4) COMP.                                
199600                                                                          
199700 01  ACTL-LEN              PIC 9(4) COMP.                                 
199800 01  MAX-LEN               PIC 9(4) COMP.                                 
199900                                                                          
200000 01  LEN-X.                                                               
200100     02  LEN-N             PIC S9(4) COMP.                                
200200                                                                          
200300 01  WORK-NX.                                                             
200400     02  WORK-N            PIC S9(4) COMP.                                
200500                                                                          
200600 01  WORK-X                PIC X(80).                                     
200700                                                                          
200800 01  ERROR-CALL            PIC X(10).                                     
200900 01  ERROR-SOCKET-ID      PIC S9(9) COMP.                                 
201000 01  ERROR-MSG             PIC X(80).                                     
201100                                                                          
201200 01  LONG-ERROR            PIC S9(9) COMP VALUE ZERO.                     
201300 01  FILLER REDEFINES LONG-ERROR.                                         
201400     02  FILLER            PIC XX.                                        
201500     02  SHORT-ERROR       PIC S9(4) COMP.                                
201600                                                                          
201700 01  DISP-N2               PIC 99.                                        
201800 01  DISP-N3               PIC 999.                                       
201900 01  DISP-SN4              PIC ----9.                                     
202000 01  DISP-SN5              PIC -----9.                                    
202100                                                                          
202200*==================================*                                      
202300 LINKAGE SECTION.                                                         
202400*==================================*                                      
202500                                                                          
202600 01  SOCKET-ID            PIC S9(9) COMP SYNC.                            
202700                                                                          
202800 01  DATA-LEN              PIC S9(4) COMP.                                
202900                                                                          
203000 01  DATA-BUFFER           PIC X(4096).                                   
203100                                                                          
203200 01  N-TIMEOUT             PIC S9(4) COMP.                                
203300                                                                          
203400 01  N-ERR                 PIC S9(4) COMP.                                
203500                                                                          
203600******************************************************************        
203700 PROCEDURE DIVISION USING SOCKET-ID DATA-LEN DATA-BUFFER                  
203800                          N-TIMEOUT N-ERR.                                
203900******************************************************************        
204000                                                                          
204100 1000-BEGIN.                                                              
204200D    DISPLAY THIS-PROG "1000-BEGIN".                                      
204300*-----Data-Len cannot be < 1 character-----*                              
204400                                                                          
204500     IF DATA-LEN < 1                                                      
204600        MOVE -5 TO LONG-ERROR N-ERR                                       
204700        PERFORM 9010-IPC-CALL-ERROR                                       
204800        GO TO 1900-RETURN.                                                
204900                                                                          
205000     MOVE ZERO TO N-ERR.                                                  
205100                                                                          
205200*-----Data-Len cannot exceed 4096 characters-----*                        
205300                                                                          
205400     IF DATA-LEN > 4096                                                   
205500        MOVE -6 TO LONG-ERROR N-ERR                                       
205600        PERFORM 9010-IPC-CALL-ERROR                                       
205700        GO TO 1900-RETURN.                                                
205800                                                                          
205900                                                                          
206000                                                                          
206100*-----Get the length-----*                                                
206200                                                                          
206300*------>> N-TIMEOUT will be set by the calling program.                   
206400     MOVE N-TIMEOUT     TO DISP-N3.                                       
206500*--       N-TIMEOUT will not be edited here.                              
206600                                                                          
206700D    DISPLAY THIS-PROG " Set timeout to " DISP-N3   " seconds".           
206800     COMPUTE WORK-N = N-TIMEOUT  * 10.                                    
206900     CALL INTRINSIC "IPCCONTROL" USING                                    
207000         SOCKET-ID \3\ WORK-NX \2\ \\ \\ \\ LONG-ERROR.                   
207100     IF LONG-ERROR NOT = ZERO                                             
207200         MOVE "IPCCONTROL" TO ERROR-CALL                                  
207300         MOVE SOCKET-ID TO ERROR-SOCKET-ID                                
207400         PERFORM 9010-IPC-CALL-ERROR                                      
207500         GO TO 1900-RETURN.                                               
207600                                                                          
207700*    Receive the length                                                   
207800                                                                          
207900D    DISPLAY THIS-PROG "Receive the length".                              
208000     MOVE DATA-LEN TO MAX-LEN.                                            
208100     MOVE 2 TO I2.                                                        
208200     CALL INTRINSIC "IPCRECV" USING                                       
208300         SOCKET-ID LEN-X I2 \\ \\ LONG-ERROR.                             
208400     IF LONG-ERROR NOT = ZERO                                             
208500         MOVE "IPCRECV" TO ERROR-CALL                                     
208600         MOVE SOCKET-ID TO ERROR-SOCKET-ID                                
208700         PERFORM 9010-IPC-CALL-ERROR                                      
208800         GO TO 1900-RETURN.                                               
208900     MOVE LEN-N TO DISP-SN4.                                              
209000D    DISPLAY THIS-PROG "Length=" DISP-SN4 " bytes".                       
209100     MOVE LEN-N TO DATA-LEN ACTL-LEN.                                     
209200     IF LEN-N = -9999                                                     
209300         GO TO 1900-RETURN                                                
209400     ELSE                                                                 
209500         IF ACTL-LEN GREATER THAN MAX-LEN                                 
209600D            MOVE ACTL-LEN TO DISP-SN4                                    
209700D            DISPLAY THIS-PROG "Receive length=" DISP-SN4                 
209800D            MOVE MAX-LEN TO DISP-SN4                                     
209900D            DISPLAY THIS-PROG "Maximum length=" DISP-SN4                 
210000             MOVE -7 TO LONG-ERROR N-ERR                                  
210100             PERFORM 9010-IPC-CALL-ERROR.                                 
210200                                                                          
210300*-----Get the data-----*                                                  
210400                                                                          
210500*    Set timeout to 5 minutes                                             
210600                                                                          
210700D    DISPLAY THIS-PROG "Set timeout to 5 minutes".                        
210800     MOVE 3000 TO WORK-N.                                                 
210900*    CALL INTRINSIC "IPCCONTROL" USING                                    
211000*        SOCKET-ID \3\ WORK-NX \2\ \\ \\ \\ LONG-ERROR.                   
211100*    IF LONG-ERROR NOT = ZERO                                             
211200*        MOVE "IPCCONTROL" TO ERROR-CALL                                  
211300*        MOVE SOCKET-ID TO ERROR-SOCKET-ID                                
211400*        PERFORM 9010-IPC-CALL-ERROR                                      
211500*        GO TO 1900-RETURN.                                               
211600*                                                                         
211700*    Receive the data                                                     
211800                                                                          
211900D    DISPLAY THIS-PROG "Receive the data".                                
212000D    DISPLAY THIS-PROG "MAX-LEN=[" MAX-LEN "]".                           
212100D    DISPLAY THIS-PROG "ACTL-LEN=[" ACTL-LEN "]".                         
212200     MOVE SPACES TO DATA-BUFFER(1:MAX-LEN).                               
212300     IF ACTL-LEN GREATER THAN MAX-LEN                                     
212400         MOVE MAX-LEN TO RECV-LEN                                         
212500     ELSE                                                                 
212600         MOVE ACTL-LEN TO RECV-LEN.                                       
212700     IF RECV-LEN = ZERO                                                   
212800        GO TO 1900-RETURN.                                                
212900     MOVE 1 TO RECV-LOC.                                                  
213000     PERFORM UNTIL RECV-LEN LESS THAN 1                                   
213100D        MOVE RECV-LEN TO DISP-SN4                                        
213200D        DISPLAY THIS-PROG "Receiving" DISP-SN4 " bytes"                  
213300         MOVE RECV-LEN TO I2                                              
213400         CALL INTRINSIC "IPCRECV" USING SOCKET-ID                         
213500             DATA-BUFFER(RECV-LOC:) I2 \\ \\ LONG-ERROR                   
213600         IF LONG-ERROR NOT = ZERO                                         
213700             MOVE "IPCRECV" TO ERROR-CALL                                 
213800             MOVE SOCKET-ID TO ERROR-SOCKET-ID                            
213900             PERFORM 9010-IPC-CALL-ERROR                                  
214000             GO TO 1900-RETURN                                            
214100         END-IF                                                           
214200D        MOVE I2 TO DISP-SN4                                              
214300D        DISPLAY THIS-PROG "Received" DISP-SN4 " bytes"                   
214400D        MOVE RECV-LOC TO I                                               
214500D        MOVE I2 TO L                                                     
214600D        PERFORM UNTIL L < 1                                              
214700D            IF L > 60                                                    
214800D                MOVE 60 TO N                                             
214900D            ELSE                                                         
215000D                MOVE L TO N                                              
215100D            END-IF                                                       
215200D            DISPLAY THIS-PROG "[" DATA-BUFFER(I:N) "]"                   
215300D            ADD N TO I                                                   
215400D            SUBTRACT N FROM L                                            
215500D        END-PERFORM                                                      
215600         ADD I2 TO RECV-LOC                                               
215700         SUBTRACT I2 FROM RECV-LEN                                        
215800     END-PERFORM.                                                         
215900                                                                          
216000*-----Ignore any excess data (ACTL-LEN > MAX-LEN)-----*                   
216100                                                                          
216200     IF ACTL-LEN GREATER THAN MAX-LEN                                     
216300         COMPUTE RECV-LEN = ACTL-LEN - MAX-LEN                            
216400D        MOVE RECV-LEN TO DISP-SN4                                        
216500D        DISPLAY THIS-PROG "Ignoring" DISP-SN4 " bytes"                   
216600         PERFORM UNTIL RECV-LEN LESS THAN 1                               
216700D            MOVE RECV-LEN TO DISP-SN4                                    
216800D            DISPLAY THIS-PROG "Receiving" DISP-SN4 " bytes"              
216900             IF RECV-LEN GREATER THAN 80                                  
217000                 MOVE 80 TO I2                                            
217100             ELSE                                                         
217200                 MOVE RECV-LEN TO I2                                      
217300             END-IF                                                       
217400             CALL INTRINSIC "IPCRECV" USING SOCKET-ID                     
217500                 WORK-X I2 \\ \\ LONG-ERROR                               
217600             IF LONG-ERROR NOT = ZERO AND 59                              
217700                 MOVE "IPCRECV" TO ERROR-CALL                             
217800                 MOVE SOCKET-ID TO ERROR-SOCKET-ID                        
217900                 PERFORM 9010-IPC-CALL-ERROR                              
218000                 GO TO 1900-RETURN                                        
218100             END-IF                                                       
218200             IF N-ERR = 59                                                
218300                MOVE 0 TO N-ERR I2                                        
218400             END-IF                                                       
218500D            MOVE I2 TO DISP-SN4                                          
218600D            DISPLAY THIS-PROG "Received" DISP-SN4 " bytes"               
218700D            MOVE 1 TO I                                                  
218800D            MOVE I2 TO L                                                 
218900D            PERFORM UNTIL L < 1                                          
219000D                IF L > 60                                                
219100D                    MOVE 60 TO N                                         
219200D                ELSE                                                     
219300D                    MOVE L TO N                                          
219400D                END-IF                                                   
219500D                DISPLAY THIS-PROG "[" WORK-X(I:N) "]"                    
219600D                ADD N TO I                                               
219700D                SUBTRACT N FROM L                                        
219800D            END-PERFORM                                                  
219900             SUBTRACT I2 FROM RECV-LEN                                    
220000         END-PERFORM                                                      
220100     END-IF.                                                              
220200                                                                          
220300*--------- SEND ACK TO THE REMOTE PROCESS -------------                   
220400     MOVE "Y" TO ACKBUF.                                                  
220500     CALL "J3KWRITACK" USING SOCKET-ID ACKBUF N-ERR.                      
220600                                                                          
220700*-----Return to caller-----*                                              
220800                                                                          
220900 1900-RETURN.                                                             
221000D    DISPLAY THIS-PROG "1900-RETURN".                                     
221100     GOBACK.                                                              
221200                                                                          
221300*-----IPC call error-----*                                                
221400                                                                          
221500 9010-IPC-CALL-ERROR.                                                     
221600D    DISPLAY THIS-PROG "9010-IPC-CALL-ERROR".                             
221700     MOVE LONG-ERROR TO N-ERR.                                            
221800     MOVE LONG-ERROR TO DISP-SN4.                                         
221900     MOVE ERROR-SOCKET-ID TO DISP-SN5.                                    
222000D    DISPLAY THIS-PROG "Error" DISP-SN4 " occurred calling "              
222100D        ERROR-CALL " - DISCRIPTOR" DISP-SN5.                             
222200     MOVE LONG-ERROR TO I2.                                               
222300     MOVE SPACES TO ERROR-MSG.                                            
222400     MOVE I2 TO N-ERR.                                                    
222500     INITIALIZE ERROR-MSG I.                                              
222600     IF N-ERR NOT = 59                                                    
222700        CALL "J3KSOCKERR" USING N-ERR ERROR-MSG I                         
222800     ELSE                                                                 
222900        CALL "J3KSOCKERR" USING N-ERR ERROR-MSG I                         
223000        MOVE 11 TO N-ERR                                                  
223100        INITIALIZE ERROR-MSG I                                            
223200        CALL "J3KSOCKERR" USING N-ERR ERROR-MSG I.                        
223300     MOVE I TO N2.                                                        
223400D    IF LONG-ERROR = ZERO                                                 
223500D        DISPLAY THIS-PROG "----------IPC ERROR MESSAGE----------"        
223600D        DISPLAY ERROR-MSG(1:N2).                                         
223700                                                                          
223800 END PROGRAM J3KREADSOCKTO.                                               
223900$TITLE "J3KSHOW SUBROUTINE"                                               
224000$PAGE "J3KSHOW  - Display's databuffer 40 bytes per line."                
225100$CONTROL SYNC32,RLFILE,LIST,DYNAMIC,OPTFEATURES=LINKALIGNED16             
225300 IDENTIFICATION DIVISION.                                                 
225500 PROGRAM-ID. J3KSHOW.                                                     
226200 ENVIRONMENT DIVISION.                                                    
226400 CONFIGURATION SECTION.                                                   
226500 SOURCE-COMPUTER. HP3000.                                                 
226600* SOURCE-COMPUTER. HP3000 WITH DEBUGGING MODE.                            
226700 OBJECT-COMPUTER. HP3000.                                                 
226800 SPECIAL-NAMES.                                                           
226900     CONDITION-CODE IS CC.                                                
227100 DATA DIVISION.                                                           
227300 WORKING-STORAGE SECTION.                                                 
227400 01  THIS-PROGRAM.                                                        
227500     02 THIS-PROG          PIC X(8) VALUE SPACES.                         
227600     02 RESTOF-THISPROG    PIC X(28) VALUE SPACES.                        
227700 01  SUB-PROG              PIC X(12) VALUE " J3KSHOW   ".                 
227800 01  I                     PIC S9(4) COMP.                                
227900 01  J                     PIC S9(4) COMP.                                
228000 01  K                     PIC S9(4) COMP.                                
228100 01  L                     PIC S9(4) COMP.                                
228200 01  N                     PIC S9(4) COMP.                                
228300 01  LEN                   PIC S9(4) COMP.                                
228400 01  LOC                   PIC S9(4) COMP.                                
228500                                                                          
228600 01  BUFF                  PIC X(80).                                     
228700 01  DISP-SN4              PIC ----9.                                     
228800 01  DATA-LEN-MAX          PIC S9(4) COMP.                                
228900 01  NUM-X.                                                               
229000     02  NUM               PIC 9(4) COMP.                                 
229100 LINKAGE SECTION.                                                         
229200 01  DATA-REC              PIC X(4096).                                   
229300 01  LINK-LEN              PIC S9(4) COMP.                                
229400*================================================================*        
229500 PROCEDURE DIVISION USING DATA-REC LINK-LEN.                              
229600*================================================================*        
229700 1000-BEGIN.                                                              
229800     CALL "PROCNAME" USING THIS-PROGRAM.                                  
229900                                                                          
230000D    DISPLAY THIS-PROG SUB-PROG "1000-BEGIN ".                            
230100     CALL INTRINSIC ".LEN." USING DATA-REC GIVING DATA-LEN-MAX.           
230200     MOVE 1 TO LOC.                                                       
230300     MOVE LINK-LEN TO LEN.                                                
230400     MOVE LEN TO DISP-SN4.                                                
230500     DISPLAY THIS-PROG  " Data length=" DISP-SN4.                         
230600     IF LEN GREATER THAN DATA-LEN-MAX MOVE DATA-LEN-MAX TO LEN.           
230700     PERFORM UNTIL LEN < 1                                                
230800         IF LEN > 40                                                      
230900             MOVE 40 TO N                                                 
231000         ELSE                                                             
231100             MOVE LEN TO N                                                
231200         END-IF                                                           
231300         MOVE SPACES TO BUFF                                              
231400         PERFORM VARYING I FROM 1 BY 1 UNTIL I > N                        
231500             COMPUTE J = LOC + I - 1                                      
231600             COMPUTE K = I * 2                                            
231700             IF DATA-REC(J:1) LESS THAN SPACE                             
231800                 MOVE "" TO BUFF(K:1)                                    
231900             ELSE                                                         
232000                 MOVE DATA-REC(J:1) TO BUFF(K:1)                          
232100             END-IF                                                       
232200         END-PERFORM                                                      
232300         IF N = 40                                                        
232400             DISPLAY BUFF WITH NO ADVANCING                               
232500         ELSE                                                             
232600             COMPUTE L = N * 2                                            
232700             DISPLAY BUFF(1:L)                                            
232800         END-IF                                                           
232900         MOVE SPACES TO BUFF                                              
233000         PERFORM VARYING I FROM 1 BY 1 UNTIL I > N                        
233100             COMPUTE J = LOC + I - 1                                      
233200             IF (I / 2) * 2 = I                                           
233300                 MOVE DATA-REC(J:1) TO NUM-X(2:1)                         
233400             ELSE                                                         
233500                 MOVE ZERO TO NUM                                         
233600                 MOVE DATA-REC(J:1) TO NUM-X(1:1)                         
233700             END-IF                                                       
233800             COMPUTE K = (I - 1) / 2 * 4 + 1                              
233900             CALL INTRINSIC "ASCII" USING NUM \16\ BUFF(K:)               
234000         END-PERFORM                                                      
234100         IF N = 40                                                        
234200             DISPLAY BUFF WITH NO ADVANCING                               
234300         ELSE                                                             
234400             COMPUTE J = LEN * 2                                          
234500             DISPLAY BUFF(1:J)                                            
234600         END-IF                                                           
234700         ADD N TO LOC                                                     
234800         SUBTRACT N FROM LEN                                              
234900     END-PERFORM.                                                         
235000*========== Return to caller ==========*                                  
235100 9999-RETURN.                                                             
235200D    DISPLAY THIS-PROG SUB-PROG "9999-RETURN".                            
235300     GOBACK.                                                              
235400 END PROGRAM J3KSHOW.                                                     
235500$PAGE "J3KCONN - Open a NETWORK Communications link"                      
236600$CONTROL SYNC32,RLFILE,LIST,DYNAMIC,OPTFEATURES=LINKALIGNED16             
236700 IDENTIFICATION DIVISION.                                                 
236800 PROGRAM-ID. J3KCONN.                                                     
236900 AUTHOR.     Michael Anderson.                                            
237100 DATE-COMPILED.                                                           
239000 ENVIRONMENT DIVISION.                                                    
239200 CONFIGURATION SECTION.                                                   
239300 SOURCE-COMPUTER. HP3000.                                                 
239400* SOURCE-COMPUTER. HP3000 WITH DEBUGGING MODE.                            
239500 OBJECT-COMPUTER. HP3000.                                                 
239600 SPECIAL-NAMES.                                                           
239700     CONDITION-CODE IS CC.                                                
240000 DATA DIVISION.                                                           
240400 WORKING-STORAGE SECTION.                                                 
240700 01  I                     PIC S9(4) COMP.                                
240800 01  N                     PIC S9(4) COMP.                                
240900                                                                          
241000 01  THIS-PROG             PIC X(11) VALUE "J3KCONNTCP ".                 
241100                                                                          
241200 01  PARM                  PIC S9(4) COMP.                                
241300                                                                          
241400 01  INFO-LEN              PIC S9(4) COMP.                                
241500                                                                          
241600 COPY INFOSTR OF J3KLIB.                                                  
241700                                                                          
241800 01 CURRENT-MINUTES        PIC S9(9) COMP VALUE 0.                        
241900 01 MPENAME                PIC X(36) VALUE SPACES.                        
242000                                                                          
242100 01 DELETE-TABLE.                                                         
242200    02 DELTBL              PIC S9(4) COMP VALUE 0.                        
242300    02 DELTBL-ENTRY OCCURS 48 TIMES.                                      
242400       05 DELREC           PIC S9(9) COMP.                                
242500                                                                          
242600                                                                          
242700 01 I2                     PIC S9(9) COMP VALUE 0.                        
242800 01 CONN-TYPE-SW           PIC X VALUE "0".                               
242900    88 SERVER-CONNECTION VALUE "1".                                       
243000    88 DIRECT-TCP        VALUE "2".                                       
243200                                                                          
243300 01 TIMENUM-STAMP.                                                        
243400    02  TIMENUM-DATE       PIC X(8) VALUE SPACES.                         
243500    02  TIMENUM-TIME       PIC X(6) VALUE SPACES.                         
243600                                                                          
243700 01 DATABASE-TABLE.                                                       
243800    02 DATA-BASE-NAME      PIC X(36) OCCURS 1.                            
243900 01 NETDBPASS              PIC X(8)   VALUE "READER; ".                   
244000 01 NETDB                  PIC S9(4) COMP VALUE 1.                        
244100 01 ALL-LIST               PIC X(2)   VALUE "@;".                         
244200 01 STATUS-AREA.                                                          
244300     03 CONDITION-WORD     PIC S9(4) COMP   VALUE 0.                      
244400        88 NO-IMAGE-ERRORS              VALUE 0.                          
244500        88 IMAGE-ERRORS            VALUES ARE -9999 THRU -1               
244600                                              1 THRU  9999.               
244700        88 BEG-OF-CHAIN                 VALUE 14.                         
244800        88 END-OF-CHAIN                 VALUE 15.                         
244900        88 NO-ENTRY                     VALUE 17.                         
245000     03 RECORD-LENGTH      PIC S9(4) COMP   VALUE 0.                      
245100     03 RECORD-NUMBER      PIC S9(9) COMP   VALUE 0.                      
245200     03 ENTRIES-IN-CHAIN   PIC S9(9) COMP   VALUE 0.                      
245300     03 PREV-RECORD-NO     PIC S9(9) COMP   VALUE 0.                      
245400     03 NEXT-RECORD-NO     PIC S9(9) COMP   VALUE 0.                      
245500                                                                          
245600     COPY IMAGE    OF J3KLIB.                                             
245700     COPY CONSTAT  OF J3KLIB.                                             
245800                                                                          
245900*============================================*                            
246000 LINKAGE SECTION.                                                         
246100*============================================*                            
246200                                                                          
246300 01  SOCKET-ID            PIC S9(9) COMP SYNC.                            
246400                                                                          
246500 01  SERVICE-NAME          PIC X(8).                                      
246600                                                                          
246700 01  PASSWORD              PIC X(8).                                      
246800                                                                          
246900 01  HOST-NAME             PIC X(8).                                      
247000                                                                          
247100 01  N-ERR                 PIC S9(4) COMP.                                
247200                                                                          
247300******************************************************************        
247400 PROCEDURE DIVISION USING                                                 
247500     SOCKET-ID SERVICE-NAME PASSWORD HOST-NAME N-ERR.                     
247600******************************************************************        
247700                                                                          
247800 1000-BEGIN.                                                              
247900D    DISPLAY THIS-PROG "1000-BEGIN".                                      
248000     MOVE ZERO TO N-ERR.                                                  
248100     CALL INTRINSIC ".LEN." USING INFO-STRING GIVING INFO-LEN.            
248200     MOVE INFO-LEN TO I.                                                  
248300     CALL INTRINSIC "GETINFO" USING INFO-STRING I PARM.                   
248400                                                                          
248500     IF I = INFO-LEN AND INFO-MODE = "SERVER"                             
248600D        DISPLAY THIS-PROG "Server mode"                                  
248700         MOVE "1" TO CONN-TYPE-SW                                         
248800         CALL "J3KOPENSRVR" USING SOCKET-ID SERVICE-NAME                  
248900             PASSWORD HOST-NAME N-ERR INFO-STRING PARM.                   
249000                                                                          
249100     IF NOT SERVER-CONNECTION                                             
249200D        DISPLAY THIS-PROG "Client mode"                                  
249300         PERFORM 2000-CHECK-CONSTAT.                                      
249400                                                                          
249500     IF DIRECT-TCP                                                        
249600D       DISPLAY THIS-PROG " Connect DIRECT TCP/IP"                        
249700         CALL "J3KCONNA"    USING                                         
249800             SOCKET-ID SERVICE-NAME PASSWORD HOST-NAME N-ERR              
249900         IF N-ERR NOT = 0  AND -2 AND -3 AND -4                           
250000            MOVE "3" TO CONN-TYPE-SW                                      
250100D           DISPLAY THIS-PROG " DIRECT TCP/IP FAILED"                     
250200            PERFORM 2001-ADD-CONSTAT.                                     
250300                                                                          
251000     GO TO 1900-RETURN.                                                   
251100                                                                          
251200*---------------------------------------------------------------          
251300 2000-CHECK-CONSTAT.                                                      
251400     INITIALIZE CONSTAT-BUFFER TIMENUM-STAMP.                             
251500     MOVE "2" TO CONN-TYPE-SW.                                            
251600     CALL "PROCNAME" USING MPENAME.                                       
251700D    DISPLAY THIS-PROG " Checking connect status for " MPENAME.           
251800     CALL "GETCURRENT" USING TIMENUM-DATE I2 I.                           
251900     ACCEPT TIMENUM-TIME FROM TIME.                                       
252000     CALL "TIMENUM" USING TIMENUM-STAMP I2 I.                             
252100     MOVE I2 TO CURRENT-MINUTES.                                          
252200     PERFORM 2010-OPEN-NETDB.                                             
252300     MOVE DI-PROGNAME TO SEARCH-ITEM.                                     
252400     MOVE MPENAME TO SEARCH-KEY.                                          
252500     PERFORM FIND-CONSTAT.                                                
252600     IF NO-IMAGE-ERRORS                                                   
252700        PERFORM LOCK-CONSTAT                                              
252800        PERFORM UNTIL END-OF-CHAIN  OR IMAGE-ERRORS                       
252900         INITIALIZE CONSTAT-BUFFER                                        
253000         PERFORM GET-CONSTAT-CHAINED                                      
253100         IF NOT END-OF-CHAIN                                              
253200            MOVE CONSTAT-BUFFER(1:14) TO TIMENUM-STAMP                    
253300            MOVE 0 TO I2 I                                                
253400            CALL "TIMENUM" USING TIMENUM-STAMP I2 I                       
253500            IF ( CURRENT-MINUTES - 15 ) > I2                              
253600               ADD 1 TO DELTBL                                            
253700               MOVE RECORD-NUMBER TO DELREC(DELTBL)                       
253800D              DISPLAY CONSTAT-BUFFER                                     
253900D              DISPLAY "IS OLDER THAN 15 MINUTES."                        
254000            ELSE                                                          
254100D              DISPLAY CONSTAT-BUFFER                                     
254200D              DISPLAY "IS NOT OLDER THAN 15 MINUTES."                    
254300               MOVE "3" TO CONN-TYPE-SW                                   
254400            END-IF                                                        
254500         END-IF                                                           
254600        END-PERFORM                                                       
254700        PERFORM VARYING I FROM 1  BY 1 UNTIL I > DELTBL                   
254800         MOVE DELREC(I) TO RECORD-NUMBER                                  
254900         PERFORM GET-CONSTAT-DIRECT                                       
255000D        DISPLAY "DELETING [" CONSTAT-BUFFER "]"                          
255100         PERFORM DELETE-CONSTAT                                           
255200        END-PERFORM.                                                      
255300     PERFORM 2011-CLOSE-NETDB.                                            
255400*---------------------------------------------------------------          
255500 2001-ADD-CONSTAT.                                                        
255600     INITIALIZE CONSTAT-BUFFER TIMENUM-STAMP.                             
255700D    DISPLAY THIS-PROG " ADDING DIRECT CONNECT FAILURE RECORD".           
255800     CALL "PROCNAME" USING MPENAME.                                       
255900     CALL "GETCURRENT" USING CONSTAT-DATE-STAMP I2 I.                     
256000     ACCEPT CONSTAT-TIME-STAMP FROM TIME.                                 
256200     CALL "PROCNUM" USING I.                                              
256300     MOVE I TO CONSTAT-PIN.                                               
256400     MOVE MPENAME TO CONSTAT-PROGNAME.                                    
256500D    DISPLAY  THIS-PROG " [" CONSTAT-BUFFER "]".                          
256600     PERFORM 2010-OPEN-NETDB.                                             
256700     PERFORM LOCK-CONSTAT.                                                
256800     PERFORM PUT-CONSTAT.                                                 
256900     PERFORM 2011-CLOSE-NETDB.                                            
257000                                                                          
257100     COPY CONSTAT0 OF J3KLIB                                              
257200          REPLACING ==GO TO== BY ==PERFORM==.                             
257300D    CALL "DBEXPLAIN" USING STATUS-AREA.                                  
257400                                                                          
257500     COPY CONSTAT1 OF J3KLIB                                              
257600          REPLACING ==GO TO== BY ==PERFORM==.                             
257700D    CALL "DBEXPLAIN" USING STATUS-AREA.                                  
257800                                                                          
257900     COPY CONSTAT2 OF J3KLIB                                              
258000          REPLACING ==GO TO== BY ==PERFORM==.                             
258100D    CALL "DBEXPLAIN" USING STATUS-AREA.                                  
258200                                                                          
258300     COPY CONSTAT4 OF J3KLIB                                              
258400          REPLACING ==GO TO== BY ==PERFORM==.                             
258500D    CALL "DBEXPLAIN" USING STATUS-AREA.                                  
258600                                                                          
258700     COPY CONSTAT5 OF J3KLIB                                              
258800          REPLACING ==GO TO== BY ==PERFORM==.                             
258900D    CALL "DBEXPLAIN" USING STATUS-AREA.                                  
259000                                                                          
259100     COPY CONSTAT6 OF J3KLIB                                              
259200          REPLACING ==GO TO== BY ==PERFORM==.                             
259300D    CALL "DBEXPLAIN" USING STATUS-AREA.                                  
259400                                                                          
259500     COPY CONSTAT7 OF J3KLIB                                              
259600          REPLACING ==GO TO== BY ==PERFORM==.                             
259700D    CALL "DBEXPLAIN" USING STATUS-AREA.                                  
259800                                                                          
259900     COPY CONSTAT8 OF J3KLIB                                              
260000          REPLACING ==GO TO== BY ==PERFORM==.                             
260100D    CALL "DBEXPLAIN" USING STATUS-AREA.                                  
260200                                                                          
260300     COPY CONSTAT9 OF J3KLIB                                              
260400          REPLACING ==GO TO== BY ==PERFORM==.                             
260500D    CALL "DBEXPLAIN" USING STATUS-AREA.                                  
260600                                                                          
260700*---------------------------------------------------------------          
260800 2010-OPEN-NETDB.                                                         
260900     MOVE "  NETDB.PUB.J3K;" TO DATA-BASE-NAME(1).                        
261000     MOVE "WRITER;" TO NETDBPASS.                                         
261100     MOVE 1 TO NETDB.                                                     
261200     CALL "DBOPEN" USING DATA-BASE-NAME(NETDB) NETDBPASS MODE-1           
261300                         STATUS-AREA.                                     
261400     IF IMAGE-ERRORS                                                      
261500         PERFORM 9000-IMAGE-ERROR.                                        
261600D    CALL "DBEXPLAIN" USING STATUS-AREA.                                  
261700                                                                          
261800*------------------------------*                                          
261900 2011-CLOSE-NETDB.                                                        
262000     CALL "DBCLOSE" USING DATA-BASE-NAME(NETDB)   NULL-ITEM               
262100         MODE-1 STATUS-AREA.                                              
262200*-------------------------------------                                    
262300 9000-IMAGE-ERROR.                                                        
262400   CALL "DBEXPLAIN" USING STATUS-AREA.                                    
262500                                                                          
262600                                                                          
262700 1900-RETURN.                                                             
262800D    DISPLAY THIS-PROG "1900-RETURN".                                     
262900     GOBACK.                                                              
263000                                                                          
263100 END PROGRAM J3KCONN.                                                     
263200$PAGE "J3KCONNA - Establish a DIRECT TCP client Connection"               
264300$CONTROL SYNC32,RLFILE,LIST,DYNAMIC,OPTFEATURES=LINKALIGNED16             
264400 IDENTIFICATION DIVISION.                                                 
264500 PROGRAM-ID. J3KCONNA.                                                    
264600 AUTHOR.     M ANDERSON.                                                  
264700 DATE-COMPILED.                                                           
265700 ENVIRONMENT DIVISION.                                                    
265900 CONFIGURATION SECTION.                                                   
266000 SOURCE-COMPUTER. HP3000.                                                 
266100* SOURCE-COMPUTER. HP3000 WITH DEBUGGING MODE.                            
266200 OBJECT-COMPUTER. HP3000.                                                 
266300 SPECIAL-NAMES.                                                           
266400     CONDITION-CODE IS CC.                                                
266600 INPUT-OUTPUT SECTION.                                                    
266700 FILE-CONTROL.                                                            
266800                                                                          
266900     SELECT SERVICE-FILE ASSIGN TO "SERVICES".                            
267000                                                                          
267100******************************************************************        
267200 DATA DIVISION.                                                           
267600 FILE SECTION.                                                            
267900 FD  SERVICE-FILE.                                                        
268000 COPY SERVICES OF J3KLIB.                                                 
268300 WORKING-STORAGE SECTION.                                                 
268600 01  I                     PIC S9(4) COMP.                                
268700 01  I2                    PIC S9(9) COMP.                                
268800 01  J                     PIC S9(4) COMP.                                
268900 01  J2                    PIC S9(9) COMP.                                
269000 01  L                     PIC S9(4) COMP.                                
269100 01  L2                    PIC S9(9) COMP.                                
269200 01  ACKTIMEOUT            PIC S9(4) COMP.                                
269300 01  ACKBUF                PIC X VALUE SPACES.                            
269400     88 GOOD-ACK           VALUE "Y".                                     
269500     88 BAD-ACK            VALUE "N".                                     
269600 01  N                     PIC S9(4) COMP.                                
269700 01  N2                    PIC S9(9) COMP.                                
269800                                                                          
269900 01  FILE-STATUS           PIC XX.                                        
270000                                                                          
270100 01  THIS-PROG             PIC X(9) VALUE "J3KCONNA ".                    
270200                                                                          
270300 01  ACTUAL-HOST           PIC X(8)  VALUE SPACES.                        
270400 01  SHIFT-STRANG          PIC X(8)  VALUE SPACES.                        
270500                                                                          
270600 01  TCP-ADDRESS-N         PIC S9(9) COMP.                                
270700 01  FILLER REDEFINES TCP-ADDRESS-N.                                      
270800     02  FILLER            PIC XX.                                        
270900     02  TCP-ADDRESS       PIC XX.                                        
271000                                                                          
271100 01  SERV-FILE-STMT.                                                      
271200     02  FILLER            PIC X(20) VALUE "FILE SERVICES=SERVIC".        
271300     02  FILLER            PIC X(18) VALUE "ES.PUB.J3K;SHR ".             
271400     02  FILLER            PIC X VALUE %15.                               
271500                                                                          
271600 01  SERV-RESET-STMT.                                                     
271700     02  FILLER            PIC X(15) VALUE "RESET SERVICES ".             
271800     02  FILLER            PIC X VALUE %15.                               
271900                                                                          
272000 01  DEST-SOCKET-ID       PIC S9(9) COMP.                                 
272100                                                                          
272200 01  ERROR-CALL            PIC X(10).                                     
272300 01  ERROR-SOCKET-ID      PIC S9(9) COMP.                                 
272400 01  ERROR-MSG             PIC X(80).                                     
272500                                                                          
272600 01  LONG-ERROR            PIC S9(9) COMP VALUE ZERO.                     
272700 01  FILLER REDEFINES LONG-ERROR.                                         
272800     02  FILLER            PIC XX.                                        
272900     02  SHORT-ERROR       PIC S9(4) COMP.                                
273000                                                                          
273100 01  WORK-NX.                                                             
273200     02  WORK-N            PIC S9(4) COMP.                                
273300                                                                          
273400 01  ASCII-VALUE           PIC S9(4) COMP VALUE 0.                        
273500 01  CHARACTER-ARRAY REDEFINES ASCII-VALUE.                               
273600     02 FIRST-BYTE         PIC X.                                         
273700     02 ASCII-CHAR         PIC X.                                         
273800                                                                          
273900 01  WORK-X                PIC X(80).                                     
274000                                                                          
274100 01  DISP-N2               PIC 99.                                        
274200 01  DISP-N3               PIC 999.                                       
274300 01  DISP-N4               PIC 9(4).                                      
274400 01  DISP-SN4              PIC ----9.                                     
274500 01  DISP-SN5              PIC -----9.                                    
274600                                                                          
274700 01  RECV-LEN            PIC S9(4) COMP.                                  
274800 01  RECV-LOC            PIC S9(4) COMP.                                  
274900                                                                          
275000 01  RESP-BUFFER.                                                         
275100     02  RESP-PASSED-FAILED PIC X(6).                                     
275200     02  RESP-PIN-NO        PIC 9(8).                                     
275300                                                                          
275400 COPY SECURITY OF J3KLIB REPLACING ==EXTERNAL== BY == ==.                 
275500*============================================*                            
275600 LINKAGE SECTION.                                                         
275700*============================================*                            
275800                                                                          
275900 01  SOCKET-ID          PIC S9(9) COMP SYNC.                              
276000                                                                          
276100 01  SERVICE-NAME          PIC X(8).                                      
276200                                                                          
276300 01  PASSWORD              PIC X(8).                                      
276400                                                                          
276500 01  HOST-NAME             PIC X(8).                                      
276600                                                                          
276700 01  N-ERR                 PIC S9(4) COMP.                                
276800                                                                          
276900******************************************************************        
277000 PROCEDURE DIVISION USING SOCKET-ID SERVICE-NAME                          
277100                                         PASSWORD HOST-NAME N-ERR.        
277200******************************************************************        
277300                                                                          
277400 1000-BEGIN.                                                              
277500*-----SERVICE-NAME must be upper case-----------*                         
277600     MOVE SERVICE-NAME TO SHIFT-STRANG.                                   
277700     PERFORM VARYING I FROM 1 BY 1 UNTIL I > 8                            
277800      INITIALIZE ASCII-VALUE                                              
277900      MOVE SHIFT-STRANG(I:1) TO ASCII-CHAR                                
278000      IF ASCII-VALUE IS GREATER THAN 96 AND LESS THAN 123                 
278100         SUBTRACT 32 FROM ASCII-VALUE                                     
278200      END-IF                                                              
278300      MOVE ASCII-CHAR TO SHIFT-STRANG(I:1)                                
278400     END-PERFORM.                                                         
278500     IF SHIFT-STRANG NOT = SERVICE-NAME                                   
278600D       DISPLAY "Service name " QUOTE SERVICE-NAME QUOTE                  
278700D               " has been Upshifted --> "                                
278800D               QUOTE SHIFT-STRANG QUOTE                                  
278900        MOVE SHIFT-STRANG TO SERVICE-NAME.                                
279000*-----HOST-NAME must be upper case-----------*                            
279100     MOVE HOST-NAME TO SHIFT-STRANG.                                      
279200     PERFORM VARYING I FROM 1 BY 1 UNTIL I > 8                            
279300      INITIALIZE ASCII-VALUE                                              
279400      MOVE SHIFT-STRANG(I:1) TO ASCII-CHAR                                
279500      IF ASCII-VALUE IS GREATER THAN 96 AND LESS THAN 123                 
279600         SUBTRACT 32 FROM ASCII-VALUE                                     
279700      END-IF                                                              
279800      MOVE ASCII-CHAR TO SHIFT-STRANG(I:1)                                
279900     END-PERFORM.                                                         
280000     IF SHIFT-STRANG NOT = HOST-NAME                                      
280100D       DISPLAY "Host name " QUOTE HOST-NAME QUOTE                        
280200D               " has been Upshifted --> "                                
280300D               QUOTE SHIFT-STRANG QUOTE                                  
280400        MOVE SHIFT-STRANG TO HOST-NAME.                                   
280500D    DISPLAY THIS-PROG "1000-BEGIN - SERVICE-NAME=["                      
280600D        SERVICE-NAME "]".                                                
280700     MOVE ZERO TO N-ERR SOCKET-ID.                                        
280800                                                                          
280900*-----Look up SERVICE-NAME in SERVICES file-----*                         
281000                                                                          
281100*    Open SERVICES file                                                   
281200                                                                          
281300     CALL INTRINSIC "COMMAND" USING SERV-FILE-STMT I N.                   
281400     IF I NOT = ZERO                                                      
281500D        MOVE I TO DISP-SN4                                               
281600D        DISPLAY THIS-PROG "Error" DISP-SN4                               
281700D            " occurred doing FILE command for SERVICES file"             
281800         MOVE -3 TO LONG-ERROR N-ERR                                      
281900         PERFORM 9010-IPC-CALL-ERROR                                      
282000         GO TO 1900-RETURN.                                               
282100     OPEN INPUT SERVICE-FILE.                                             
282200                                                                          
282300*    Read through SERVICES file looking for SERVICE-NAME                  
282400                                                                          
282500 1100-READ-SERVICES.                                                      
282600D    DISPLAY THIS-PROG "1100-READ-SERVICES".                              
282700     READ SERVICE-FILE AT END                                             
282800D        DISPLAY THIS-PROG "Unable to find service"                       
282900         MOVE -4 TO LONG-ERROR N-ERR                                      
283000         PERFORM 9010-IPC-CALL-ERROR                                      
283100         GO TO 1900-RETURN.                                               
283200                                                                          
283300     IF ( SERV-SERVICE-NAME NOT = SERVICE-NAME )                          
283400     OR ( SERV-HOST         NOT = SPACES AND HOST-NAME  )                 
283500     OR ( SERV-SERVICE-TYPE NOT = "C" )                                   
283600        GO TO 1100-READ-SERVICES.                                         
283700                                                                          
283800*----- Get TCP address -----*                                             
283900                                                                          
284000     MOVE SERV-TCP-ADDRESS TO TCP-ADDRESS-N.                              
284100*-----Get destination SOCKET-ID-----*                                     
284200                                                                          
284300D    DISPLAY THIS-PROG "Calling IPCDEST - TCP-ADDRESS="                   
284400D        SERV-TCP-ADDRESS.                                                
284500     MOVE 8 TO L2.                                                        
284600     MOVE HOST-NAME TO ACTUAL-HOST.                                       
284700     PERFORM UNTIL L2 = 1 OR ACTUAL-HOST(L2:1) NOT = SPACE                
284800         SUBTRACT 1 FROM L2                                               
284900     END-PERFORM.                                                         
285000     CALL INTRINSIC "IPCDEST" USING \3\ ACTUAL-HOST L2 \4\                
285100         TCP-ADDRESS \2\ \\ \\ DEST-SOCKET-ID LONG-ERROR.                 
285200     IF LONG-ERROR NOT = ZERO                                             
285300         MOVE "IPCDEST" TO ERROR-CALL                                     
285400         MOVE DEST-SOCKET-ID TO ERROR-SOCKET-ID                           
285500         PERFORM 9010-IPC-CALL-ERROR                                      
285600         GO TO 1900-RETURN.                                               
285700D    MOVE DEST-SOCKET-ID TO DISP-SN4.                                     
285800D    DISPLAY THIS-PROG "Found DEST-SOCKET-ID=" DISP-SN4.                  
285900                                                                          
286000*-----Connect with the remote host-----*                                  
286100                                                                          
286200D    DISPLAY THIS-PROG "Calling IPCCONNECT".                              
286300     MOVE -1 TO I2.                                                       
286400     CALL INTRINSIC "IPCCONNECT" USING                                    
286500         I2 DEST-SOCKET-ID \\ \\ SOCKET-ID LONG-ERROR.                    
286600     IF LONG-ERROR NOT = ZERO                                             
286700         MOVE "IPCCONNECT" TO ERROR-CALL                                  
286800         MOVE DEST-SOCKET-ID TO ERROR-SOCKET-ID                           
286900         PERFORM 9010-IPC-CALL-ERROR                                      
287000         GO TO 1900-RETURN.                                               
287100D    MOVE SOCKET-ID TO DISP-SN4.                                          
287200D    DISPLAY THIS-PROG "Connected SOCKET-ID=" DISP-SN4.                   
287300                                                                          
287400*-----Do IPCRECV to complete the connection-----*                         
287500                                                                          
287600*    Set timeout to 5 minutes                                             
287700                                                                          
287800D    DISPLAY THIS-PROG "Set timeout to 5 minutes".                        
287900     MOVE 3000 TO WORK-N.                                                 
288000     CALL INTRINSIC "IPCCONTROL" USING                                    
288100         SOCKET-ID \3\ WORK-NX \2\ \\ \\ \\ LONG-ERROR.                   
288200     IF LONG-ERROR NOT = ZERO                                             
288300         MOVE "IPCCONTROL" TO ERROR-CALL                                  
288400         MOVE SOCKET-ID TO ERROR-SOCKET-ID                                
288500         PERFORM 9010-IPC-CALL-ERROR                                      
288600         GO TO 1900-RETURN.                                               
288700                                                                          
288800*    Call IPCRECV                                                         
288900                                                                          
289000D    DISPLAY THIS-PROG "Call IPCRECV".                                    
289100     MOVE SPACES TO RESP-BUFFER.                                          
289200     MOVE ZERO TO RECV-LEN.                                               
289300     MOVE RECV-LEN TO I2                                                  
289400     CALL INTRINSIC "IPCRECV" USING SOCKET-ID                             
289500         RESP-BUFFER I2 \\ \\ LONG-ERROR                                  
289600     IF LONG-ERROR NOT = ZERO                                             
289700         MOVE "IPCRECV" TO ERROR-CALL                                     
289800         MOVE SOCKET-ID TO ERROR-SOCKET-ID                                
289900         PERFORM 9010-IPC-CALL-ERROR                                      
290000         GO TO 1900-RETURN.                                               
290100D        DISPLAY THIS-PROG "Connection complete".                         
290200                                                                          
290300*-----Send the security redord-----*                                      
290400                                                                          
290500D    DISPLAY THIS-PROG "Send security record".                            
290600     MOVE SPACES TO SECURITY-RECORD.                                      
290700     MOVE "SECURITY" TO SEC-ID.                                           
290800     MOVE "USERNAME" TO SEC-USER-NAME.                                    
290900     MOVE "PASSWORD" TO SEC-PASSWORD.                                     
291000     MOVE SERVICE-NAME TO SEC-SERVICE-NAME.                               
291100     CALL INTRINSIC "WHO" USING \\ \\ \\ \\ \\ \\ \\ I.                   
291200     MOVE I TO SEC-DEVICE-NO.                                             
291300     CALL INTRINSIC "PROCINFO" USING I N \0\ \1\ WORK-NX.                 
291400     MOVE WORK-N TO SEC-PIN-NO.                                           
291500     MOVE HOST-NAME TO SEC-HOST.                                          
291600     CALL INTRINSIC ".LEN." USING SECURITY-RECORD GIVING I2.              
291700     MOVE I2 TO DISP-SN4.                                                 
291800D    DISPLAY THIS-PROG "Sending" DISP-SN4 " bytes".                       
291900D    MOVE 1 TO I.                                                         
292000D    MOVE I2 TO L.                                                        
292100D    PERFORM UNTIL L < 1                                                  
292200D        IF L > 60                                                        
292300D            MOVE 60 TO N                                                 
292400D        ELSE                                                             
292500D            MOVE L TO N                                                  
292600D        END-IF                                                           
292700D        DISPLAY THIS-PROG "[" SECURITY-RECORD(I:N) "]"                   
292800D        ADD N TO I                                                       
292900D        SUBTRACT N FROM L                                                
293000D    END-PERFORM.                                                         
293100     CALL INTRINSIC "IPCSEND" USING                                       
293200         SOCKET-ID SECURITY-RECORD I2 \\ \\ LONG-ERROR.                   
293300     IF LONG-ERROR NOT = ZERO                                             
293400         MOVE "IPCSEND" TO ERROR-CALL                                     
293500         MOVE SOCKET-ID TO ERROR-SOCKET-ID                                
293600         PERFORM 9010-IPC-CALL-ERROR                                      
293700         GO TO 1900-RETURN.                                               
293800*-----Wait for ack. from the remote process ------*                       
293900     MOVE 300 TO ACKTIMEOUT.                                              
294000     CALL "J3KREADACK" USING SOCKET-ID ACKTIMEOUT ACKBUF N-ERR.           
294100     IF N-ERR NOT = 0 GO TO 1900-RETURN.                                  
294200     IF BAD-ACK                                                           
294300        MOVE -10 TO LONG-ERROR N-ERR                                      
294400        PERFORM 9010-IPC-CALL-ERROR                                       
294500        GO TO 1900-RETURN.                                                
294600                                                                          
294700                                                                          
294800*-----Get response-----*                                                  
294900                                                                          
295000*    Set timeout to 5 minutes                                             
295100                                                                          
295200D    DISPLAY THIS-PROG "Set timeout to 5 minutes".                        
295300     MOVE 3000 TO WORK-N.                                                 
295400     CALL INTRINSIC "IPCCONTROL" USING                                    
295500         SOCKET-ID \3\ WORK-NX \2\ \\ \\ \\ LONG-ERROR.                   
295600     IF LONG-ERROR NOT = ZERO                                             
295700         MOVE "IPCCONTROL" TO ERROR-CALL                                  
295800         MOVE SOCKET-ID TO ERROR-SOCKET-ID                                
295900         PERFORM 9010-IPC-CALL-ERROR                                      
296000         GO TO 1900-RETURN.                                               
296100                                                                          
296200*    Receive the response                                                 
296300                                                                          
296400D    DISPLAY THIS-PROG "Receive the response".                            
296500     MOVE SPACES TO RESP-BUFFER.                                          
296600     MOVE 14 TO RECV-LEN.                                                 
296700     MOVE 1 TO RECV-LOC.                                                  
296800     PERFORM UNTIL RECV-LEN LESS THAN 1                                   
296900D        MOVE RECV-LEN TO DISP-SN4                                        
297000D        DISPLAY THIS-PROG "Receiving" DISP-SN4 " bytes"                  
297100         MOVE RECV-LEN TO I2                                              
297200         CALL INTRINSIC "IPCRECV" USING SOCKET-ID                         
297300             RESP-BUFFER(RECV-LOC:) I2 \\ \\ LONG-ERROR                   
297400         IF LONG-ERROR NOT = ZERO                                         
297500             MOVE "IPCRECV" TO ERROR-CALL                                 
297600             MOVE SOCKET-ID TO ERROR-SOCKET-ID                            
297700             PERFORM 9010-IPC-CALL-ERROR                                  
297800             GO TO 1900-RETURN                                            
297900         END-IF                                                           
298000D        MOVE I2 TO DISP-SN4                                              
298100D        DISPLAY THIS-PROG "Received" DISP-SN4 " bytes"                   
298200D        MOVE RECV-LOC TO I                                               
298300D        MOVE I2 TO L                                                     
298400D        PERFORM UNTIL L < 1                                              
298500D            IF L > 60                                                    
298600D                MOVE 60 TO N                                             
298700D            ELSE                                                         
298800D                MOVE L TO N                                              
298900D            END-IF                                                       
299000D            DISPLAY THIS-PROG "[" RESP-BUFFER(I:N) "]"                   
299100D            ADD N TO I                                                   
299200D            SUBTRACT N FROM L                                            
299300D        END-PERFORM                                                      
299400         ADD I2 TO RECV-LOC                                               
299500         SUBTRACT I2 FROM RECV-LEN                                        
299600     END-PERFORM.                                                         
299700*-----Send ack to the remote process -----------                          
299800     MOVE "Y" TO ACKBUF.                                                  
299900     CALL "J3KWRITACK" USING SOCKET-ID ACKBUF N-ERR.                      
300000                                                                          
300100     IF RESP-PASSED-FAILED = "PASSED"                                     
300200D        DISPLAY THIS-PROG "Server PIN number=" RESP-PIN-NO               
300300         GO TO 1900-RETURN.                                               
300400                                                                          
300500*-----Failed - get error number-----*                                     
300600                                                                          
300700D    DISPLAY THIS-PROG "Failed! Security on remote.".                     
300800     MOVE -2   TO LONG-ERROR N-ERR.                                       
300900     PERFORM 9010-IPC-CALL-ERROR.                                         
301000                                                                          
301100*-----Return to caller-----*                                              
301200                                                                          
301300 1900-RETURN.                                                             
301400D    DISPLAY THIS-PROG "1900-RETURN".                                     
301500     CALL INTRINSIC "COMMAND" USING SERV-RESET-STMT I N.                  
301600     GOBACK.                                                              
301700                                                                          
301800*-----IPC call error-----*                                                
301900                                                                          
302000 9010-IPC-CALL-ERROR.                                                     
302100D    DISPLAY THIS-PROG "9010-IPC-CALL-ERROR".                             
302200     MOVE LONG-ERROR TO N-ERR.                                            
302300     MOVE LONG-ERROR TO DISP-SN4.                                         
302400     MOVE ERROR-SOCKET-ID TO DISP-SN5.                                    
302500D    DISPLAY THIS-PROG "Error" DISP-SN4 " occurred calling "              
302600D        ERROR-CALL " - DISCRIPTOR" DISP-SN5.                             
302700     MOVE LONG-ERROR TO I2.                                               
302800     MOVE SPACES TO ERROR-MSG.                                            
302900     MOVE I2 TO N-ERR.                                                    
303000     INITIALIZE ERROR-MSG I.                                              
303100     CALL "J3KSOCKERR" USING N-ERR ERROR-MSG I.                           
303200     MOVE I TO N2.                                                        
303300D    IF LONG-ERROR = ZERO                                                 
303400D        DISPLAY THIS-PROG "----------IPC ERROR MESSAGE----------"        
303500D        DISPLAY ERROR-MSG(1:N2).                                         
303600                                                                          
303700 END PROGRAM J3KCONNA.                                                    
351100$PAGE "J3KFATAL - Add failure record to the CONN-STATUS Data set"         
352200$CONTROL SYNC32,RLFILE,LIST,DYNAMIC,OPTFEATURES=LINKALIGNED16             
352300 IDENTIFICATION DIVISION.                                                 
352400 PROGRAM-ID. J3KFATAL.                                                    
352500 AUTHOR.     M ANDERSON.                                                  
352600 DATE-COMPILED.                                                           
353400 ENVIRONMENT DIVISION.                                                    
353600 CONFIGURATION SECTION.                                                   
353700 SOURCE-COMPUTER. HP3000.                                                 
353800* SOURCE-COMPUTER. HP3000 WITH DEBUGGING MODE.                            
353900 OBJECT-COMPUTER. HP3000.                                                 
354000 SPECIAL-NAMES.                                                           
354100     CONDITION-CODE IS CC.                                                
354400 DATA DIVISION.                                                           
354800 WORKING-STORAGE SECTION.                                                 
355100 01  I                     PIC S9(4) COMP.                                
355200 01  N                     PIC S9(4) COMP.                                
355400 01  THIS-PROG             PIC X(9) VALUE "J3KFATAL ".                    
355600 01  PARM                  PIC S9(4) COMP.                                
355800 01  INFO-LEN              PIC S9(4) COMP.                                
356000 COPY INFOSTR OF J3KLIB.                                                  
356200 01 CURRENT-MINUTES        PIC S9(9) COMP VALUE 0.                        
356300 01 MPENAME                PIC X(36) VALUE SPACES.                        
356500 01 DELETE-TABLE.                                                         
356600    02 DELTBL              PIC S9(4) COMP VALUE 0.                        
356700    02 DELTBL-ENTRY OCCURS 48 TIMES.                                      
356800       05 DELREC           PIC S9(9) COMP.                                
356900                                                                          
357000                                                                          
357100 01 I2                     PIC S9(9) COMP VALUE 0.                        
357200 01 CONN-TYPE-SW           PIC X VALUE "0".                               
357300    88 SERVER-CONNECTION VALUE "1".                                       
357400    88 DIRECT-TCP        VALUE "2".                                       
357500    88 USING-THE-MUX     VALUE "3".                                       
357600                                                                          
357700 01 TIMENUM-STAMP.                                                        
357800    02  TIMENUM-DATE       PIC X(8) VALUE SPACES.                         
357900    02  TIMENUM-TIME       PIC X(6) VALUE SPACES.                         
358000                                                                          
358100 01 DATABASE-TABLE.                                                       
358200    02 DATA-BASE-NAME      PIC X(36) OCCURS 1.                            
358300 01 NETDBPASS              PIC X(8)   VALUE "READER; ".                   
358400 01 NETDB                  PIC S9(4) COMP VALUE 1.                        
358500 01 ALL-LIST               PIC X(2)   VALUE "@;".                         
358600 01 STATUS-AREA.                                                          
358700     03 CONDITION-WORD     PIC S9(4) COMP   VALUE 0.                      
358800        88 NO-IMAGE-ERRORS              VALUE 0.                          
358900        88 IMAGE-ERRORS            VALUES ARE -9999 THRU -1               
359000                                              1 THRU  9999.               
359100        88 BEG-OF-CHAIN                 VALUE 14.                         
359200        88 END-OF-CHAIN                 VALUE 15.                         
359300        88 NO-ENTRY                     VALUE 17.                         
359400     03 RECORD-LENGTH      PIC S9(4) COMP   VALUE 0.                      
359500     03 RECORD-NUMBER      PIC S9(9) COMP   VALUE 0.                      
359600     03 ENTRIES-IN-CHAIN   PIC S9(9) COMP   VALUE 0.                      
359700     03 PREV-RECORD-NO     PIC S9(9) COMP   VALUE 0.                      
359800     03 NEXT-RECORD-NO     PIC S9(9) COMP   VALUE 0.                      
359900                                                                          
360000     COPY IMAGE    OF J3KLIB.                                             
360100     COPY CONSTAT  OF J3KLIB.                                             
360600 PROCEDURE DIVISION.                                                      
361000 1000-BEGIN.                                                              
361100D    DISPLAY THIS-PROG "1000-BEGIN".                                      
361200D    DISPLAY THIS-PROG " Adding DIRECT TCP/IP FAILED record"              
361300     PERFORM 2001-ADD-CONSTAT.                                            
361400     GO TO 1900-RETURN.                                                   
361600*---------------------------------------------------------------          
361700 2001-ADD-CONSTAT.                                                        
361800     INITIALIZE CONSTAT-BUFFER TIMENUM-STAMP.                             
361900D    DISPLAY THIS-PROG " ADDING DIRECT CONNECT FAILURE RECORD".           
362000     CALL "PROCNAME" USING MPENAME.                                       
362100     CALL "GETCURRENT" USING CONSTAT-DATE-STAMP I2 I.                     
362200     ACCEPT CONSTAT-TIME-STAMP FROM TIME.                                 
362300     MOVE "1" TO CONSTAT-MUX-SW.                                          
362400     CALL "PROCNUM" USING I.                                              
362500     MOVE I TO CONSTAT-PIN.                                               
362600     MOVE MPENAME TO CONSTAT-PROGNAME.                                    
362700D    DISPLAY  THIS-PROG " [" CONSTAT-BUFFER "]".                          
362800     PERFORM 2010-OPEN-NETDB.                                             
362900     PERFORM LOCK-CONSTAT.                                                
363000     PERFORM PUT-CONSTAT.                                                 
363100     PERFORM 2011-CLOSE-NETDB.                                            
363200                                                                          
363300     COPY CONSTAT0 OF J3KLIB                                              
363400          REPLACING ==GO TO== BY ==PERFORM==.                             
363500D    CALL "DBEXPLAIN" USING STATUS-AREA.                                  
363600                                                                          
363700     COPY CONSTAT1 OF J3KLIB                                              
363800          REPLACING ==GO TO== BY ==PERFORM==.                             
363900D    CALL "DBEXPLAIN" USING STATUS-AREA.                                  
364000                                                                          
364100     COPY CONSTAT2 OF J3KLIB                                              
364200          REPLACING ==GO TO== BY ==PERFORM==.                             
364300D    CALL "DBEXPLAIN" USING STATUS-AREA.                                  
364400                                                                          
364500     COPY CONSTAT4 OF J3KLIB                                              
364600          REPLACING ==GO TO== BY ==PERFORM==.                             
364700D    CALL "DBEXPLAIN" USING STATUS-AREA.                                  
364800                                                                          
364900     COPY CONSTAT5 OF J3KLIB                                              
365000          REPLACING ==GO TO== BY ==PERFORM==.                             
365100D    CALL "DBEXPLAIN" USING STATUS-AREA.                                  
365200                                                                          
365300     COPY CONSTAT6 OF J3KLIB                                              
365400          REPLACING ==GO TO== BY ==PERFORM==.                             
365500D    CALL "DBEXPLAIN" USING STATUS-AREA.                                  
365600                                                                          
365700     COPY CONSTAT7 OF J3KLIB                                              
365800          REPLACING ==GO TO== BY ==PERFORM==.                             
365900D    CALL "DBEXPLAIN" USING STATUS-AREA.                                  
366000                                                                          
366100     COPY CONSTAT8 OF J3KLIB                                              
366200          REPLACING ==GO TO== BY ==PERFORM==.                             
366300D    CALL "DBEXPLAIN" USING STATUS-AREA.                                  
366400                                                                          
366500     COPY CONSTAT9 OF J3KLIB                                              
366600          REPLACING ==GO TO== BY ==PERFORM==.                             
366700D    CALL "DBEXPLAIN" USING STATUS-AREA.                                  
366800                                                                          
366900*---------------------------------------------------------------          
367000 2010-OPEN-NETDB.                                                         
367100     MOVE "  NETDB.PUB.J3K;" TO DATA-BASE-NAME(1).                        
367200     MOVE "WRITER;" TO NETDBPASS.                                         
367300     MOVE 1 TO NETDB.                                                     
367400     CALL "DBOPEN" USING DATA-BASE-NAME(NETDB) NETDBPASS MODE-1           
367500                         STATUS-AREA.                                     
367600     IF IMAGE-ERRORS                                                      
367700         PERFORM 9000-IMAGE-ERROR.                                        
367800D    CALL "DBEXPLAIN" USING STATUS-AREA.                                  
367900                                                                          
368000*------------------------------*                                          
368100 2011-CLOSE-NETDB.                                                        
368200     CALL "DBCLOSE" USING DATA-BASE-NAME(NETDB)   NULL-ITEM               
368300         MODE-1 STATUS-AREA.                                              
368400*-------------------------------------                                    
368500 9000-IMAGE-ERROR.                                                        
368600   CALL "DBEXPLAIN" USING STATUS-AREA.                                    
368700                                                                          
368800                                                                          
368900 1900-RETURN.                                                             
369000D    DISPLAY THIS-PROG "1900-RETURN".                                     
369100     GOBACK.                                                              
369200                                                                          
369300 END PROGRAM J3KFATAL.                                                    
